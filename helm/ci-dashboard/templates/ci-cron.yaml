{{- $root := . -}}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "ci-dashboard.fullname" . }}-queries
  labels:
    {{- include "ci-dashboard.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.schedule | quote }}
  jobTemplate:
    metadata:
      labels:
        {{- include "ci-dashboard.labels" . | nindent 8 }}
    spec:
      template:
        metadata:
          labels:
            {{- include "ci-dashboard.labels" . | nindent 12 }}
        spec:
          restartPolicy: "Never"
          containers:
          - name: db-pusher
            image: "{{ .Values.dbPusher.image.name }}:{{ .Values.dbPusher.image.tag }}"
            imagePullPolicy: IfNotPresent
            command: 
            - /bin/bash
            - -c
            - '
                pip install -r {{ .Values.dbPusher.script.mountPath }}/requirements.txt;
                python {{ .Values.dbPusher.script.mountPath }}/{{ .Values.dbPusher.script.name }};
              '
            volumeMounts:
            - name: {{ .Values.outputEnv.name | quote }}
              mountPath: {{ .Values.outputEnv.value | quote }}
            - name: {{ .Values.dbPusher.script.secret.name | quote }}
              mountPath: {{ .Values.dbPusher.script.mountPath | quote }}
            env:
            - name: INFLUXDB_URL
              value: "http://{{ include "ci-dashboard.fullname" . }}-influxdb:8086"
            - name: {{ .Values.outputEnv.name }}
              value: {{ .Values.outputEnv.value }}
            {{- with .Values.dbPusher.env }}
            {{- . | toYaml | nindent 12 }}
            {{- end }}
            resources:
            {{- toYaml .Values.dbPusher.resources | nindent 14 }}
          initContainers:
          {{- range $i, $retriever := .Values.retrievers }}
          {{- include "ci-dashboard.insertRetriever" (dict "root" $root "retriever" $retriever) | nindent 10 }}
          {{- end }}
          volumes:
          {{- include "ci-dashboard.insertRetrieverVolumes" $root | nindent 10 }}
          {{- include "ci-dashboard.insertDbPusherVolume" $root | nindent 10 }}
  suspend: false
  startingDeadlineSeconds: 100
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1