# PR 16841: Defer hashing in staged ledger diff application

## Problem Statement
When performing transaction application, all merkle ledger hashes are recomputed for every account update. This is wasteful for a number of reasons:

1. Transactions normally contain more than one account update and a hash computed for an account update is sometimes overwritten by a subsequent account update
2. Ledger's depth is 35, whereas only around 2^18 records are actually populated. This means that each account update induces an wasteful overhead of at least 17 hashes
3. When an account is touched in a few transactions of the same block, it's gets hashed a few times, whereas in fact only the final hash is truly needed

## Solution
Defer computation of hashes in mask. When an account is added, it's stacked in a list `unhashed_accounts` of masks which is processed at the time of next access to hashes.

## Invariant Assumption
- Assumes downstream user of a masking merkle tree doesn't care the intermediate hashes calculated when a transaction is partially applied. We count on the user to trigger recalculation if it's actually needed. This is not needed at all for normal transactions, though.

## Improvements
This fix improved performance of handling 9-account-update transactions by ~60% (measured by #14582 on top of #15979 and #15978).

## Background Thread
[Original pull request](https://github.com/MinaProtocol/mina/pull/15980) by @georgeee
