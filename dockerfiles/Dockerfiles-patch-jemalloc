ARG image=minaprotocol/mina-daemon:3.2.0-97ad487-noble-mainnet
FROM ${image}

ENV DEBIAN_FRONTEND=noninteractive


RUN apt-get update --quiet --yes \
  && apt-get install --quiet --yes --no-install-recommends bzip2 build-essential \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/jemalloc
RUN curl -L https://github.com/jemalloc/jemalloc/releases/download/5.3.0/jemalloc-5.3.0.tar.bz2 | tar xjf - -C .


WORKDIR /tmp/jemalloc/jemalloc-5.3.0
RUN ./configure --enable-prof && make -j$(nproc)

RUN make install LIBDIR=/usr/lib/x86_64-linux-gnu

# https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Leak-Checking
ENV MALLOC_CONF=prof_leak:true,lg_prof_sample:0,prof_final:true

WORKDIR /RUNDIR
