# The container to pull artifacts from, expected to be from stage 3-builder
# but it can also be supplied as a build arg to pull from a specific pre-built image for speed
ARG MINA_BUILDER_STAGE=builder
FROM ${MINA_BUILDER_STAGE} as prebuilt-stage
ARG image=debian:bullseye-slim
# Mina zkapp test transaction tool docker image, built and packaged by the staged dockerfiles directly into a clean production container
FROM ${image} as zkapp-test-transaction
ARG deb_version=1.3.1.2
ARG MINA_BRANCH=develop


ENV DEBIAN_FRONTEND noninteractive
RUN echo "Building image with version $deb_codename $deb_release $deb_version"

# Dependencies
RUN DEBIAN_FRONTEND=noninteractive apt-get --quiet --yes update \
    && DEBIAN_FRONTEND=noninteractive apt-get --quiet --yes upgrade \
    && DEBIAN_FRONTEND=noninteractive apt-get --quiet --yes --no-install-recommends install \
        procps \
        curl \
        jq \
        dumb-init \
        libssl1.1 \
        libgomp1 \
        'libjemalloc.$' \
        libpq-dev \
        apt-transport-https \
        ca-certificates \
        dnsutils \
	      apt-utils \
        man \
    && rm -rf /var/lib/apt/lists/*



# Mina zkapp test transaction tool package, copied from the builder container
COPY --from=prebuilt-stage /tmp/artifacts/mina-zkapp-test-transaction_${deb_version}.deb /root/mina-zkapp-test-package.deb
# And then installed
RUN echo "Building image with version $deb_version from compiled debian package for network $network" \
  && dpkg -i /root/mina-zkapp-test-package.deb \
  && rm -rf /root/mina-zkapp-test-package.deb
