
FROM ubuntu:22.04

ENV DHALL_VERSION=1.30.0
ENV DHALL_JSON_VERSION=1.6.2
ENV YQ_VERSION=4.44.3

ENV GIT_SSL_CAINFO=/etc/ssl/certs/ca-certificates.crt

RUN apt-get update && apt-get install -y --no-install-recommends \
	bash \
	curl \
	gnupg \
	tar \
	bzip2 \
	ca-certificates \
	git \
	make \
	&& rm -rf /var/lib/apt/lists/*

SHELL ["/bin/bash", "-o", "pipefail", "-c"]


RUN git config --system --add safe.directory '*'

RUN curl -sL https://github.com/dhall-lang/dhall-haskell/releases/download/${DHALL_VERSION}/dhall-${DHALL_VERSION}-x86_64-linux.tar.bz2 | tar --extract --file=- --bzip2 --directory=/usr ./bin/dhall
RUN curl -sL https://github.com/dhall-lang/dhall-haskell/releases/download/${DHALL_VERSION}/dhall-json-${DHALL_JSON_VERSION}-x86_64-linux.tar.bz2 | tar --extract --file=- --bzip2 --directory=/usr ./bin/dhall-to-yaml


RUN curl -L "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64" -o "/usr/local/bin/yq" && chmod +x "/usr/local/bin/yq"


RUN curl -fsSL https://keys.openpgp.org/vks/v1/by-fingerprint/32A37959C2FA5C3C99EFBC32A79206696452D198 | gpg --dearmor -o /usr/share/keyrings/buildkite-agent-archive-keyring.gpg
RUN echo "deb [signed-by=/usr/share/keyrings/buildkite-agent-archive-keyring.gpg] https://apt.buildkite.com/buildkite-agent stable main" > /etc/apt/sources.list.d/buildkite-agent.list

RUN apt-get update && apt-get install -y --no-install-recommends buildkite-agent \
	&& rm -rf /var/lib/apt/lists/*