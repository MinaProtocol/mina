# Kimchi compatibility layer for WebAssembly

This code allows us to compile parts of [Kimchi](./../kimchi) into [Web Assembly
(WASM)](https://webassembly.org/), making the proof system available for use in
Web and NodeJS applications.
The WebAssembly module is also exposing all the methods and primitives that the
OCaml Mina codebase requires.

The WebAssembly module will be used in particular to define frameworks like
[o1js](https://github.com/o1-labs/o1js).

## Usage

Makefile targets are defined at the top-level of this repository.
From that location, you can run
```
make build-nodejs # (for NodeJS environments)
make build-web    # (for web browsers)
```
to compile the Kimchi library (and its dependencies) into a WebAssembly module
ready to be run in NodeJS or in the browser.

## Architecture and Inner Workings

The plonk-wasm library serves as a bridge between the Rust-based Kimchi proof
system and JavaScript environments. It consists of several key components:

### 1. Core Components

- **WebAssembly Bindings**: Uses
  [wasm-bindgen](https://rustwasm.github.io/wasm-bindgen) to expose Rust
  functions and types to JavaScript.
- **OCaml Compatibility**: Special serialization/deserialization layer
  (`wasm_ocaml_serde`) that handles conversions between Rust structures and
  JavaScript values following OCaml conventions.

### 2. Exposed Functionality

The library exposes several core components from the Kimchi proof system:

- **Cryptographic primitives**: Field elements, elliptic curve operations, and
  polynomial commitments, SRS
- **Proof generation and verification**: Tools to generate and verify proofs
  generated by the Kimchi system
- **Poseidon hash**: Bindings to the Poseidon implementation used by the Kimchi
  proof system

The methods that will be exposed in the WebAssembly module are surrounded by the
macro `#[wasm_bindgen]`.
All Rust symbols used by the OCaml client of Mina are required to be exposed in
the WebAssembly module, even if not directly desired in the user API.

### 3. Build System

The build process uses:

- [wasm-pack](https://github.com/rustwasm/wasm-pack): For compiling and
  packaging the Rust code into WebAssembly.
- **Nightly Rust**. There is no apparent reasons to use nightly, but without
  using nightly, users have encountered issues like
  [DataCloneError](https://github.com/o1-labs/o1js/issues/1989)

### 4. Memory Management

The library provides:

- Low-level pointer manipulation for efficient buffer management
- Custom vector implementations for Rust/JavaScript interoperability
- Support for handling large cryptographic structures efficiently

### 5. Module Structure

Key modules include:

- `arkworks/`: WebAssembly wrappers around the arkworks library
- `wasm_ocaml_serde/`: OCaml-compatible serialization

- Cryptographic primitives:
  - `circuit.rs`, `srs.rs`, `gate_vector.rs`, `oracle.rs`, `poly_comm.rs`,
    `poseidon.rs`, `projective.rs`, `srs.rs`
- Kimchi proof systems:
- `pasta_fp_plonk_index.rs`, `pasta_fq_plonk_index.rs`, `plonk_proof.rs` and
  `plonk_verifier_index.rs`.

## Resources

- [Rust WASM book](https://rustwasm.github.io/docs/book/game-of-life/hello-world.html)
- [WASM-bindgen book](https://rustwasm.github.io/docs/wasm-bindgen/)
- [Kimchi Documentation](./../kimchi/README.md)
