(library
 (name node_backend)
 (public_name bindings_js.node_backend)
 ;(enabled_if (= %{env:KIMCHI_NODE_BACKEND} "napi"))
 (js_of_ocaml
  (flags (:include flags.sexp))
  (javascript_files napi_backend.js))
 (instrumentation (backend bisect_ppx))
 (preprocess (pps ppx_version js_of_ocaml-ppx)))

(rule
 (targets
  plonk_napi.node
  flags.sexp)
 (deps
  build.sh
  ../../dune-build-root
  (source_tree ../../../proof-systems))
 (locks /cargo-lock)
 (action
  (progn
    (setenv CARGO_TARGET_DIR "%{read:../../dune-build-root}/cargo_kimchi_napi"
      (run bash build.sh))
    (write-file flags.sexp "()"))))
