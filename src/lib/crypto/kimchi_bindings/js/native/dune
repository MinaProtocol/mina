(library
 (name native_backend)
 (public_name bindings_js.native_backend)
 (js_of_ocaml
  (flags (:include flags.sexp))
  (javascript_files native_backend.js))
 (instrumentation (backend bisect_ppx))
 (preprocess (pps ppx_version js_of_ocaml-ppx)))

; Rule that calls build.sh to compile the Neon project and produce plonk_native.node
(rule
 (targets plonk_native.node)
 (deps
   (source_tree ../../native_prover) 
   build.sh                          
 )
 (action
  (run bash build.sh)))

; Rule to create a plonk_native.cjs that imports and exports the .node file
(rule
 (targets plonk_native.cjs)
 (deps plonk_native.node)
 (action
  (write-file plonk_native.cjs
   "const plonk_native = require('./plonk_native.node');\nmodule.exports = plonk_native;\n")))  
