(library
 (name mina_compile_config)
 (public_name mina_compile_config_nonconsensus)
 (libraries mina_compile_config_intf key_cache logger currency_nonconsensus core_kernel protocol_version mina_numbers_nonconsensus)
 (preprocessor_deps ../../config/mechanism.mlh config.mlh)
 (instrumentation (backend bisect_ppx))
 (enabled_if
  (or
   (= %{profile} nonconsensus_mainnet)
   (= %{profile} nonconsensus_medium_curves)))
 (preprocess (pps ppx_version ppx_base ppx_optcomp)))

; Fallback mode allows manual override in FS
(rule
  (target config_unpromoted.mlh)
  (mode fallback)
  (deps (source_tree ../../config))
  (action (copy ../../config/%{profile}.mlh config_unpromoted.mlh)))

; Promotion is needed for ocaml-lsp to pick up the config
(rule
  (target config.mlh)
  (mode promote)
  (deps config_unpromoted.mlh)
  (action (copy config_unpromoted.mlh config.mlh)))