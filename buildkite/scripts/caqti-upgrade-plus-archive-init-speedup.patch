From 7921159799df69fa6a7db1f2b360b624a31959c5 Mon Sep 17 00:00:00 2001
From: ember arlynx <ember.arlynx@o1labs.org>
Date: Sat, 30 Mar 2024 22:35:39 -0400
Subject: [PATCH] applied caqti+archive


diff --git a/src/app/archive/cli/archive_cli.ml b/src/app/archive/cli/archive_cli.ml
index 0868f63e37..e4cf825b0e 100644
--- a/src/app/archive/cli/archive_cli.ml
+++ b/src/app/archive/cli/archive_cli.ml
@@ -85,9 +85,7 @@ let command_prune =
        in
        let go () =
          let open Deferred.Result.Let_syntax in
-         let%bind ((module Conn) as conn) =
-           Caqti_async.connect postgres.value
-         in
+         let%bind ((module Conn) as conn) = Mina_caqti.connect postgres.value in
          let%bind () = Conn.start () in
          match%bind.Async.Deferred
            let%bind () =
diff --git a/src/app/archive/cli/dune b/src/app/archive/cli/dune
index 917ed0b1ba..5f63637d42 100644
--- a/src/app/archive/cli/dune
+++ b/src/app/archive/cli/dune
@@ -17,6 +17,7 @@
    cli_lib
    logger
    block_time
+   mina_caqti
  )
  (instrumentation (backend bisect_ppx))
  (preprocess (pps ppx_version ppx_jane ppx_mina)))
diff --git a/src/app/archive/drop_tables.sql b/src/app/archive/drop_tables.sql
index 571327de81..f9dca92cd7 100644
--- a/src/app/archive/drop_tables.sql
+++ b/src/app/archive/drop_tables.sql
@@ -105,3 +105,7 @@ DROP TABLE zkapp_events;
 DROP TABLE token_symbols;
 
 DROP TABLE voting_for;
+
+DROP TABLE zkapp_field;
+
+DROP TABLE zkapp_verification_key_hashes;
diff --git a/src/app/archive/lib/load_data.ml b/src/app/archive/lib/load_data.ml
index 1ca76d1a0b..4b4faf66dd 100644
--- a/src/app/archive/lib/load_data.ml
+++ b/src/app/archive/lib/load_data.ml
@@ -91,9 +91,9 @@ let update_of_id pool update_id =
   let open Zkapp_basic in
   let query_db ~f = Mina_caqti.query ~f pool in
   let with_pool ~f arg =
-    let open Caqti_async in
+    let open Mina_caqti in
     Pool.use
-      (fun (module Conn : CONNECTION) -> f (module Conn : CONNECTION) arg)
+      (fun (module Conn : Mina_caqti.CONNECTION) -> f (module Conn : Mina_caqti.CONNECTION) arg)
       pool
   in
   let%bind { app_state_id
@@ -636,9 +636,9 @@ let get_account_accessed ~pool (account : Processor.Accounts_accessed.t) :
     (int * Account.t) Deferred.t =
   let query_db ~f = Mina_caqti.query ~f pool in
   let with_pool ~f arg =
-    let open Caqti_async in
+    let open Mina_caqti in
     Pool.use
-      (fun (module Conn : CONNECTION) -> f (module Conn : CONNECTION) arg)
+      (fun (module Conn : Mina_caqti.CONNECTION) -> f (module Conn : Mina_caqti.CONNECTION) arg)
       pool
   in
   let pk_of_id = pk_of_id pool in
diff --git a/src/app/archive/lib/metrics.ml b/src/app/archive/lib/metrics.ml
index aac3552028..bf15430c54 100644
--- a/src/app/archive/lib/metrics.ml
+++ b/src/app/archive/lib/metrics.ml
@@ -17,7 +17,7 @@ module Max_block_height = struct
     Caqti_request.Infix.(Caqti_type.unit ->! Caqti_type.int)
       "SELECT GREATEST(0, MAX(height)) FROM blocks"
 
-  let update (module Conn : Caqti_async.CONNECTION) metric_server =
+  let update (module Conn : Mina_caqti.CONNECTION) metric_server =
     time ~label:"max_block_height" (fun () ->
         let open Deferred.Result.Let_syntax in
         let%map max_height = Conn.find query () in
@@ -40,7 +40,7 @@ module Missing_blocks = struct
       |sql}
          missing_blocks_width )
 
-  let update ~missing_blocks_width (module Conn : Caqti_async.CONNECTION)
+  let update ~missing_blocks_width (module Conn : Mina_caqti.CONNECTION)
       metric_server =
     let open Deferred.Result.Let_syntax in
     time ~label:"missing_blocks" (fun () ->
@@ -61,7 +61,7 @@ module Unparented_blocks = struct
            WHERE parent_id IS NULL
       |sql}
 
-  let update (module Conn : Caqti_async.CONNECTION) metric_server =
+  let update (module Conn : Mina_caqti.CONNECTION) metric_server =
     let open Deferred.Result.Let_syntax in
     time ~label:"unparented_blocks" (fun () ->
         let%map unparented_block_count = Conn.find query () in
@@ -73,13 +73,13 @@ end
 
 let log_error ~logger pool metric_server
     (f :
-         (module Caqti_async.CONNECTION)
+         (module Mina_caqti.CONNECTION)
       -> Mina_metrics.Archive.t
       -> (unit, [> Caqti_error.call_or_retrieve ]) Deferred.Result.t ) =
   let open Deferred.Let_syntax in
   match%map
-    Caqti_async.Pool.use
-      (fun (module Conn : Caqti_async.CONNECTION) ->
+    Mina_caqti.Pool.use
+      (fun (module Conn : Mina_caqti.CONNECTION) ->
         f (module Conn) metric_server )
       pool
   with
diff --git a/src/app/archive/lib/processor.ml b/src/app/archive/lib/processor.ml
index 939aaa8864..313b424f55 100644
--- a/src/app/archive/lib/processor.ml
+++ b/src/app/archive/lib/processor.ml
@@ -21,7 +21,6 @@
 module Archive_rpc = Rpc
 open Async
 open Core
-open Caqti_async
 open Mina_base
 open Mina_transaction
 open Mina_state
@@ -39,39 +38,89 @@ let txn_hash_to_base58_check ?(v1_transaction_hash = false) hash =
   if v1_transaction_hash then Transaction_hash.to_base58_check_v1 hash
   else Transaction_hash.to_base58_check hash
 
+let unwrap t = Result.map_error ~f:Caqti_error.show t |> Result.ok_or_failwith
+
+let ensure_local_copies (module Conn : Mina_caqti.CONNECTION) ~default tbl =
+  Hashtbl.find_or_add ~default tbl (Uri.to_string Conn.source)
+
+let load_copy' ~default ~local_copies ~typ ~query ~load_elt
+    (module Conn : Mina_caqti.CONNECTION) =
+  match Hashtbl.find local_copies (Uri.to_string Conn.source) with
+  | Some copy ->
+      Deferred.return copy
+  | None ->
+      let t_to_id = ensure_local_copies (module Conn) ~default local_copies in
+      let%bind all_rows =
+        Conn.collect_list (Mina_caqti.collect_req Caqti_type.unit typ query) ()
+      in
+      let%map () =
+        Deferred.List.iter (unwrap all_rows) ~f:(fun row ->
+            load_elt t_to_id row )
+      in
+      t_to_id
+
+let add_bidi m1 m2 ~key ~data =
+  Hashtbl.add_exn m1 ~key ~data ;
+  Hashtbl.add_exn m2 ~key:data ~data:key
+
+let add_bidi_mapped m1 m2 ~key ~data ~value =
+  Hashtbl.add_exn m1 ~key ~data ;
+  Hashtbl.add_exn m2 ~key:value ~data:key
+
 module Public_key = struct
-  let find (module Conn : CONNECTION) (t : Public_key.Compressed.t) =
-    let public_key = Public_key.Compressed.to_base58_check t in
-    Conn.find
-      (Caqti_request.Infix.(Caqti_type.string ->! Caqti_type.int)
-         "SELECT id FROM public_keys WHERE value = ?" )
-      public_key
+  type local_copy =
+    { id_to_key : (int, Public_key.Compressed.t) Hashtbl.t
+    ; key_to_id : (Public_key.Compressed.t, int) Hashtbl.t
+    }
 
-  let find_opt (module Conn : CONNECTION) (t : Public_key.Compressed.t) =
-    let public_key = Public_key.Compressed.to_base58_check t in
-    Conn.find_opt
-      (Caqti_request.Infix.(Caqti_type.string ->? Caqti_type.int)
-         "SELECT id FROM public_keys WHERE value = ?" )
-      public_key
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () ->
+        { id_to_key = Hashtbl.create (module Int)
+        ; key_to_id = Hashtbl.create (module Public_key.Compressed)
+        } )
+      ~local_copies
+      ~typ:Caqti_type.(t2 int string)
+      ~query:{sql| SELECT id, value FROM public_keys |sql}
+      ~load_elt:(fun { id_to_key; key_to_id } (id, keytext) ->
+        let key = Public_key.Compressed.of_base58_check_exn keytext in
+        add_bidi id_to_key key_to_id ~key:id ~data:key ;
+        Deferred.unit )
 
-  let find_by_id (module Conn : CONNECTION) id =
-    Conn.find
-      (Caqti_request.Infix.(Caqti_type.int ->! Caqti_type.string)
-         "SELECT value FROM public_keys WHERE id = ?" )
-      id
+  let find (module Conn : Mina_caqti.CONNECTION) (t : Public_key.Compressed.t) =
+    let%map local = load_copy (module Conn) in
+    Ok (Hashtbl.find_exn local.key_to_id t)
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let find_opt (module Conn : Mina_caqti.CONNECTION)
       (t : Public_key.Compressed.t) =
+    let%map local = load_copy (module Conn) in
+    Ok (Hashtbl.find local.key_to_id t)
+
+  let find_by_id (module Conn : Mina_caqti.CONNECTION) id =
+    let%map local = load_copy (module Conn) in
+    Ok
+      ( Hashtbl.find_exn local.id_to_key id
+      |> Public_key.Compressed.to_base58_check )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
+      (t : Public_key.Compressed.t) =
+    let%bind local = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     match%bind find_opt (module Conn) t with
     | Some id ->
         return id
     | None ->
         let public_key = Public_key.Compressed.to_base58_check t in
-        Conn.find
-          (Caqti_request.Infix.(Caqti_type.string ->! Caqti_type.int)
-             "INSERT INTO public_keys (value) VALUES (?) RETURNING id" )
-          public_key
+        let%map.Deferred.Result new_id =
+          Conn.find
+            (Mina_caqti.find_req Caqti_type.string Caqti_type.int
+               "INSERT INTO public_keys (value) VALUES (?) RETURNING id" )
+            public_key
+        in
+        add_bidi local.id_to_key local.key_to_id ~key:new_id ~data:t ;
+        new_id
 end
 
 (* Unlike other modules here, `Token_owners` does not correspond with a database table *)
@@ -100,43 +149,69 @@ module Token = struct
   include T
   include Comparable.Make (T)
 
+  type local_copy =
+    { id_to_t : (int, t) Hashtbl.t; value_to_id : (string, int) Hashtbl.t }
+
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () ->
+        { id_to_t = Hashtbl.create (module Int)
+        ; value_to_id = Hashtbl.create (module String)
+        } )
+      ~local_copies
+      ~typ:Caqti_type.(t4 int string (option int) (option int))
+      ~query:
+        {sql| SELECT id, value, owner_public_key_id, owner_token_id FROM tokens |sql}
+      ~load_elt:(fun { id_to_t; value_to_id }
+                     (id, value, owner_public_key_id, owner_token_id) ->
+        let t = { value; owner_public_key_id; owner_token_id } in
+        add_bidi_mapped id_to_t value_to_id ~key:id ~data:t ~value ;
+        Deferred.unit )
+
   let typ =
     Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
       Caqti_type.[ string; option int; option int ]
 
   let table_name = "tokens"
 
-  let find_by_id (module Conn : CONNECTION) id =
-    Conn.find
-      (find_req Caqti_type.int typ
-         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
-      id
+  let find_by_id (module Conn : Mina_caqti.CONNECTION) id =
+    let%map local = load_copy (module Conn) in
+    Ok (Hashtbl.find_exn local.id_to_t id)
 
-  let make_finder conn_finder req_finder token_id =
-    conn_finder
-      (req_finder Caqti_type.string Caqti_type.int
-         (Mina_caqti.select_cols ~table_name ~select:"id" ~cols:[ "value" ] ()) )
-      (Token_id.to_string token_id)
+  let find (module Conn : Mina_caqti.CONNECTION) token_id =
+    let%map local = load_copy (module Conn) in
+    Ok (Hashtbl.find_exn local.value_to_id (Token_id.to_string token_id))
 
-  let find (module Conn : CONNECTION) = make_finder Conn.find find_req
+  let find_opt (module Conn : Mina_caqti.CONNECTION) token_id =
+    let%map local = load_copy (module Conn) in
+    Ok (Hashtbl.find local.value_to_id (Token_id.to_string token_id))
 
-  let find_opt (module Conn : CONNECTION) =
-    make_finder Conn.find_opt find_opt_req
-
-  let find_no_owner_opt (module Conn : CONNECTION) token_id =
+  let find_no_owner_opt (module Conn : Mina_caqti.CONNECTION) token_id =
+    let%map local = load_copy (module Conn) in
     let value = Token_id.to_string token_id in
-    Conn.find_opt
-      (find_opt_req Caqti_type.string Caqti_type.int
-         {sql| SELECT id
-               FROM tokens
-               WHERE value = $1
-               AND owner_public_key_id IS NULL
-               AND owner_token_id IS NULL
-         |sql} )
-      value
+    Ok
+      ( match Hashtbl.find local.value_to_id value with
+      | Some id -> (
+          match Hashtbl.find local.id_to_t id with
+          | Some { owner_public_key_id = None; owner_token_id = None; _ } ->
+              Some id
+          | _ ->
+              None )
+      | None ->
+          None )
 
-  let set_owner (module Conn : CONNECTION) ~id ~owner_public_key_id
+  let set_owner (module Conn : Mina_caqti.CONNECTION) ~id ~owner_public_key_id
       ~owner_token_id =
+    let%bind local = load_copy (module Conn) in
+    Hashtbl.set local.id_to_t ~key:id
+      ~data:
+        { (Hashtbl.find_exn local.id_to_t id) with
+          owner_public_key_id = Some owner_public_key_id
+        ; owner_token_id = Some owner_token_id
+        } ;
+
     Conn.find
       (find_req
          Caqti_type.(t3 int int int)
@@ -148,16 +223,29 @@ module Token = struct
          |sql} )
       (id, owner_public_key_id, owner_token_id)
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) token_id =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) token_id =
+    let%bind local = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let value = Token_id.to_string token_id in
     match Token_owners.find_owner token_id with
-    | None ->
+    | None -> (
         (* not necessarily the default token *)
-        Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-          ~table_name ~cols:(Fields.names, typ)
-          (module Conn)
-          { value; owner_public_key_id = None; owner_token_id = None }
+        match Hashtbl.find local.value_to_id value with
+        | None ->
+            let t =
+              { value; owner_public_key_id = None; owner_token_id = None }
+            in
+            let%map new_id =
+              Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+                ~table_name ~cols:(Fields.names, typ)
+                (module Conn)
+                t
+            in
+            add_bidi_mapped local.id_to_t local.value_to_id ~key:new_id ~data:t
+              ~value ;
+            new_id
+        | Some id ->
+            return id )
     | Some acct_id -> (
         assert (not @@ Token_id.(equal default) token_id) ;
         assert (
@@ -181,10 +269,16 @@ module Token = struct
         | None ->
             let owner_public_key_id = Some owner_public_key_id in
             let owner_token_id = Some owner_token_id in
-            Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-              ~table_name ~cols:(Fields.names, typ)
-              (module Conn)
-              { value; owner_public_key_id; owner_token_id } )
+            let t = { value; owner_public_key_id; owner_token_id } in
+            let%map new_id =
+              Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+                ~table_name ~cols:(Fields.names, typ)
+                (module Conn)
+                t
+            in
+            add_bidi_mapped local.id_to_t local.value_to_id ~key:new_id ~data:t
+              ~value ;
+            new_id )
 end
 
 module Voting_for = struct
@@ -194,14 +288,38 @@ module Voting_for = struct
 
   let table_name = "voting_for"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) voting_for =
-    Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-      ~table_name
-      ~cols:([ "value" ], typ)
-      (module Conn)
-      (State_hash.to_base58_check voting_for)
+  type local_copy = (string, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
 
-  let load (module Conn : CONNECTION) id =
+  let load_copy =
+    load_copy'
+      ~default:(fun () -> Hashtbl.create (module String))
+      ~local_copies
+      ~typ:Caqti_type.(t2 int string)
+      ~query:{sql| SELECT id, value FROM voting_for |sql}
+      ~load_elt:(fun t_to_id (id, value) ->
+        Hashtbl.add_exn t_to_id ~key:value ~data:id ;
+        Deferred.unit )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) voting_for =
+    let%bind t_to_id = load_copy (module Conn) in
+    let voting_for = State_hash.to_base58_check voting_for in
+    match Hashtbl.find t_to_id voting_for with
+    | Some id ->
+        Deferred.Result.return id
+    | None ->
+        let%map.Deferred.Result new_id =
+          Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+            ~table_name
+            ~cols:([ "value" ], typ)
+            (module Conn)
+            voting_for
+        in
+        Hashtbl.add_exn t_to_id ~key:voting_for ~data:new_id ;
+        new_id
+
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "value" ]) )
@@ -215,14 +333,38 @@ module Token_symbols = struct
 
   let table_name = "token_symbols"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) token_symbol =
-    Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-      ~table_name
-      ~cols:([ "value" ], typ)
-      (module Conn)
-      token_symbol
+  type local_copy = (string, int) Hashtbl.t
 
-  let load (module Conn : CONNECTION) id =
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () -> Hashtbl.create (module String))
+      ~local_copies
+      ~typ:Caqti_type.(t2 int string)
+      ~query:{sql| SELECT id, value FROM token_symbols |sql}
+      ~load_elt:(fun t_to_id (id, value) ->
+        Hashtbl.add_exn t_to_id ~key:value ~data:id ;
+        Deferred.unit )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) token_symbol =
+    let%bind t_to_id = load_copy (module Conn) in
+    let open Deferred.Result.Let_syntax in
+    match Hashtbl.find t_to_id token_symbol with
+    | Some id ->
+        return id
+    | None ->
+        let%map new_id =
+          Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+            ~table_name
+            ~cols:([ "value" ], typ)
+            (module Conn)
+            token_symbol
+        in
+        Hashtbl.add_exn t_to_id ~key:token_symbol ~data:new_id ;
+        new_id
+
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "value" ]) )
@@ -243,7 +385,29 @@ module Account_identifiers = struct
 
   let table_name = "account_identifiers"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) account_id =
+  type local_copy = (int * int, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
+
+  let loaded = ref false
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () ->
+        Hashtbl.create
+          ( module struct
+            type t = int * int [@@deriving compare, sexp, hash]
+          end ) )
+      ~local_copies
+      ~typ:Caqti_type.(t3 int int int)
+      ~query:
+        {sql| SELECT id,public_key_id,token_id FROM account_identifiers |sql}
+      ~load_elt:(fun t_to_id (id, public_key_id, token_id) ->
+        Hashtbl.add_exn t_to_id ~key:(public_key_id, token_id) ~data:id ;
+        Deferred.unit )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) account_id =
+    let%bind t_to_id = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let pk = Account_id.public_key account_id in
     (* this token_id is Token_id.t *)
@@ -252,12 +416,21 @@ module Account_identifiers = struct
     (* this token_id is a Postgresql table id *)
     let%bind token_id = Token.add_if_doesn't_exist (module Conn) token_id in
     let t = { public_key_id; token_id } in
-    Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-      ~table_name ~cols:(Fields.names, typ)
-      (module Conn)
-      t
+    match Hashtbl.find t_to_id (public_key_id, token_id) with
+    | None ->
+        let%map new_id =
+          Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+            ~table_name ~cols:(Fields.names, typ)
+            (module Conn)
+            t
+        in
+        Hashtbl.add_exn t_to_id ~key:(public_key_id, token_id) ~data:new_id ;
+        new_id
+    | Some id ->
+        Deferred.Result.return id
 
-  let find_opt (module Conn : CONNECTION) account_id =
+  let find_opt (module Conn : Mina_caqti.CONNECTION) account_id =
+    let%bind t_to_id = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let pk = Account_id.public_key account_id in
     match%bind Public_key.find_opt (module Conn) pk with
@@ -269,28 +442,18 @@ module Account_identifiers = struct
         | None ->
             return None
         | Some tok_id ->
-            Conn.find_opt
-              (find_opt_req
-                 Caqti_type.(t2 int int)
-                 Caqti_type.int
-                 (Mina_caqti.select_cols ~select:"id" ~table_name
-                    ~cols:Fields.names () ) )
-              (pk_id, tok_id) )
-
-  let find (module Conn : CONNECTION) account_id =
+            return (Hashtbl.find t_to_id (pk_id, tok_id)) )
+
+  let find (module Conn : Mina_caqti.CONNECTION) account_id =
+    let%bind t_to_id = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let pk = Account_id.public_key account_id in
     let%bind public_key_id = Public_key.find (module Conn) pk in
     let token = Account_id.token_id account_id in
-    let%bind token_id = Token.find (module Conn) token in
-    Conn.find
-      (find_req
-         Caqti_type.(t2 int int)
-         Caqti_type.int
-         (Mina_caqti.select_cols ~select:"id" ~table_name ~cols:Fields.names ()) )
-      (public_key_id, token_id)
+    let%map token_id = Token.find (module Conn) token in
+    Hashtbl.find_exn t_to_id (public_key_id, token_id)
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -300,7 +463,7 @@ end
 module Zkapp_field = struct
   let table_name = "zkapp_field"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (fp : Pickles.Backend.Tick.Field.t) =
     Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
       ~table_name
@@ -308,7 +471,7 @@ module Zkapp_field = struct
       (module Conn)
       (Pickles.Backend.Tick.Field.to_string fp)
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "field" ]) )
@@ -318,7 +481,7 @@ end
 module Zkapp_field_array = struct
   let table_name = "zkapp_field_array"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (fps : Pickles.Backend.Tick.Field.t array) =
     let open Deferred.Result.Let_syntax in
     let%bind (element_ids : int array) =
@@ -333,7 +496,7 @@ module Zkapp_field_array = struct
       (module Conn)
       element_ids
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Mina_caqti.array_int_typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "element_ids" ]) )
@@ -368,7 +531,7 @@ module Zkapp_states_nullable = struct
 
   let table_name = "zkapp_states_nullable"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (fps : (Pickles.Backend.Tick.Field.t option, 'n) Vector.vec) =
     let open Deferred.Result.Let_syntax in
     let%bind (element_ids : int option list) =
@@ -405,7 +568,7 @@ module Zkapp_states_nullable = struct
       (module Conn)
       t
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -431,7 +594,7 @@ module Zkapp_states = struct
 
   let table_name = "zkapp_states"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (fps : (Pickles.Backend.Tick.Field.t, 'n) Vector.vec) =
     let open Deferred.Result.Let_syntax in
     let%bind (element_ids : int list) =
@@ -466,7 +629,7 @@ module Zkapp_states = struct
       (module Conn)
       t
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -489,7 +652,7 @@ module Zkapp_action_states = struct
 
   let table_name = "zkapp_action_states"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (fps : (Pickles.Backend.Tick.Field.t, 'n) Vector.vec) =
     let open Deferred.Result.Let_syntax in
     let%bind (element_ids : int list) =
@@ -508,7 +671,7 @@ module Zkapp_action_states = struct
       (module Conn)
       t
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -522,7 +685,7 @@ module Zkapp_verification_key_hashes = struct
 
   let table_name = "zkapp_verification_key_hashes"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (verification_key_hash : Pickles.Backend.Tick.Field.t) =
     Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
       ~table_name
@@ -530,7 +693,7 @@ module Zkapp_verification_key_hashes = struct
       (module Conn)
       (Pickles.Backend.Tick.Field.to_string verification_key_hash)
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "value" ]) )
@@ -547,7 +710,7 @@ module Zkapp_verification_keys = struct
 
   let table_name = "zkapp_verification_keys"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (vk :
         ( Pickles.Side_loaded.Verification_key.t
         , Pickles.Backend.Tick.Field.t )
@@ -565,7 +728,7 @@ module Zkapp_verification_keys = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -587,15 +750,39 @@ module Protocol_versions = struct
 
   let table_name = "protocol_versions"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) ~transaction ~network
-      ~patch =
+  type local_copy = (t, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () -> Hashtbl.create (module T))
+      ~local_copies
+      ~typ:Caqti_type.(t4 int int int int)
+      ~query:
+        {sql| SELECT id, transaction, network, patch FROM protocol_versions |sql}
+      ~load_elt:(fun t_to_id (id, transaction, network, patch) ->
+        Hashtbl.add_exn t_to_id ~key:{ transaction; network; patch } ~data:id ;
+        Deferred.unit )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) ~transaction
+      ~network ~patch =
     let t = { transaction; network; patch } in
-    Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-      ~table_name ~cols:(Fields.names, typ)
-      (module Conn)
-      t
+    let%bind t_to_id = load_copy (module Conn) in
+    match Hashtbl.find t_to_id t with
+    | Some id ->
+        return (Ok id)
+    | None ->
+        let%map.Deferred.Result new_id =
+          Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+            ~table_name ~cols:(Fields.names, typ)
+            (module Conn)
+            t
+        in
+        Hashtbl.add_exn t_to_id ~key:t ~data:new_id ;
+        new_id
 
-  let find (module Conn : CONNECTION) ~transaction ~network ~patch =
+  let find (module Conn : Mina_caqti.CONNECTION) ~transaction ~network ~patch =
     Conn.find
       (find_req
          Caqti_type.(t3 int int int)
@@ -603,14 +790,17 @@ module Protocol_versions = struct
          (Mina_caqti.select_cols ~select:"id" ~table_name ~cols:Fields.names ()) )
       (transaction, network, patch)
 
-  let find_txn_version (module Conn : CONNECTION) ~transaction =
-    Conn.collect_list
-      (collect_req Caqti_type.int Caqti_type.int
-         {sql| SELECT id FROM protocol_versions WHERE transaction = ?
-        |sql} )
-      transaction
+  let find_by_txn_version (module Conn : Mina_caqti.CONNECTION) ~transaction =
+    let%map t_to_id = load_copy (module Conn) in
+    let matching_ids =
+      Hashtbl.fold ~init:[]
+        ~f:(fun ~key ~data acc ->
+          if Int.(key.transaction = transaction) then data :: acc else acc )
+        t_to_id
+    in
+    Ok matching_ids
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -647,23 +837,81 @@ module Zkapp_permissions = struct
     in
     Caqti_type.enum ~encode ~decode "zkapp_auth_required_type"
 
-  type t =
-    { edit_state : Permissions.Auth_required.t
-    ; send : Permissions.Auth_required.t
-    ; receive : Permissions.Auth_required.t
-    ; access : Permissions.Auth_required.t
-    ; set_delegate : Permissions.Auth_required.t
-    ; set_permissions : Permissions.Auth_required.t
-    ; set_verification_key_auth : Permissions.Auth_required.t
-    ; set_verification_key_txn_version : int
-    ; set_zkapp_uri : Permissions.Auth_required.t
-    ; edit_action_state : Permissions.Auth_required.t
-    ; set_token_symbol : Permissions.Auth_required.t
-    ; increment_nonce : Permissions.Auth_required.t
-    ; set_voting_for : Permissions.Auth_required.t
-    ; set_timing : Permissions.Auth_required.t
-    }
-  [@@deriving fields, hlist]
+  module T = struct
+    type t =
+      { edit_state : Permissions.Auth_required.t
+      ; send : Permissions.Auth_required.t
+      ; receive : Permissions.Auth_required.t
+      ; access : Permissions.Auth_required.t
+      ; set_delegate : Permissions.Auth_required.t
+      ; set_permissions : Permissions.Auth_required.t
+      ; set_verification_key_auth : Permissions.Auth_required.t
+      ; set_verification_key_txn_version : int
+      ; set_zkapp_uri : Permissions.Auth_required.t
+      ; edit_action_state : Permissions.Auth_required.t
+      ; set_token_symbol : Permissions.Auth_required.t
+      ; increment_nonce : Permissions.Auth_required.t
+      ; set_voting_for : Permissions.Auth_required.t
+      ; set_timing : Permissions.Auth_required.t
+      }
+    [@@deriving fields, hlist, compare, sexp, hash]
+  end
+
+  module With_id = struct
+    type t =
+      { id : int
+      ; edit_state : Permissions.Auth_required.t
+      ; send : Permissions.Auth_required.t
+      ; receive : Permissions.Auth_required.t
+      ; access : Permissions.Auth_required.t
+      ; set_delegate : Permissions.Auth_required.t
+      ; set_permissions : Permissions.Auth_required.t
+      ; set_verification_key_auth : Permissions.Auth_required.t
+      ; set_verification_key_txn_version : int
+      ; set_zkapp_uri : Permissions.Auth_required.t
+      ; edit_action_state : Permissions.Auth_required.t
+      ; set_token_symbol : Permissions.Auth_required.t
+      ; increment_nonce : Permissions.Auth_required.t
+      ; set_voting_for : Permissions.Auth_required.t
+      ; set_timing : Permissions.Auth_required.t
+      }
+    [@@deriving fields, hlist, compare, sexp, hash]
+
+    let forget_id
+        { id = _
+        ; edit_state
+        ; send
+        ; receive
+        ; access
+        ; set_delegate
+        ; set_permissions
+        ; set_verification_key_auth
+        ; set_verification_key_txn_version
+        ; set_zkapp_uri
+        ; edit_action_state
+        ; set_token_symbol
+        ; increment_nonce
+        ; set_voting_for
+        ; set_timing
+        } =
+      { T.edit_state
+      ; send
+      ; receive
+      ; access
+      ; set_delegate
+      ; set_permissions
+      ; set_verification_key_auth
+      ; set_verification_key_txn_version
+      ; set_zkapp_uri
+      ; edit_action_state
+      ; set_token_symbol
+      ; increment_nonce
+      ; set_voting_for
+      ; set_timing
+      }
+  end
+
+  include T
 
   let typ =
     Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
@@ -683,14 +931,58 @@ module Zkapp_permissions = struct
       ; auth_required_typ
       ]
 
+  let typ_with_id : With_id.t Caqti_type.t =
+    let open With_id in
+    Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
+      [ Caqti_type.int
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; Caqti_type.int
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ; auth_required_typ
+      ]
+
   let table_name = "zkapp_permissions"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) (perms : Permissions.t) =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
+    Conn.find
+      (Mina_caqti.find_req Caqti_type.int typ
+         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
+      id
+
+  type local_copy = (t, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () -> Hashtbl.create (module T))
+      ~local_copies ~typ:typ_with_id
+      ~query:
+        (sprintf {sql| SELECT %s FROM zkapp_permissions |sql}
+           (String.concat ~sep:"," With_id.Fields.names) )
+      ~load_elt:(fun t_to_id t ->
+        Hashtbl.add_exn t_to_id ~key:(With_id.forget_id t) ~data:t.id ;
+        Deferred.unit )
+
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
+      (perms : Permissions.t) =
     let txn_version =
       Mina_numbers.Txn_version.to_int @@ snd perms.set_verification_key
     in
     let%bind versions =
-      Protocol_versions.find_txn_version (module Conn) ~transaction:txn_version
+      Protocol_versions.find_by_txn_version
+        (module Conn)
+        ~transaction:txn_version
     in
     ( match versions with
     | Ok [] ->
@@ -721,16 +1013,21 @@ module Zkapp_permissions = struct
       ; set_timing = perms.set_timing
       }
     in
-    Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
-      ~table_name ~cols:(Fields.names, typ)
-      (module Conn)
-      value
+    let%bind t_to_id = load_copy (module Conn) in
 
-  let load (module Conn : CONNECTION) id =
-    Conn.find
-      (find_req Caqti_type.int typ
-         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
-      id
+    let open Deferred.Result.Let_syntax in
+    match Hashtbl.find t_to_id value with
+    | Some id ->
+        return id
+    | None ->
+        let%map new_id =
+          Mina_caqti.insert_assuming_new ~select:("id", Caqti_type.int)
+            ~table_name ~cols:(Fields.names, typ)
+            (module Conn)
+            value
+        in
+        Hashtbl.add_exn t_to_id ~key:value ~data:new_id ;
+        new_id
 end
 
 module Zkapp_timing_info = struct
@@ -749,7 +1046,7 @@ module Zkapp_timing_info = struct
 
   let table_name = "zkapp_timing_info"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (timing_info : Account_update.Update.Timing_info.t) =
     let initial_minimum_balance =
       Currency.Balance.to_string timing_info.initial_minimum_balance
@@ -779,7 +1076,7 @@ module Zkapp_timing_info = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -793,14 +1090,14 @@ module Zkapp_uri = struct
 
   let table_name = "zkapp_uris"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) zkapp_uri =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) zkapp_uri =
     Mina_caqti.select_insert_into_cols ~select:("id", Caqti_type.int)
       ~table_name
       ~cols:([ "value" ], typ)
       (module Conn)
       zkapp_uri
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "value" ]) )
@@ -835,7 +1132,7 @@ module Zkapp_updates = struct
 
   let table_name = "zkapp_updates"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (update : Account_update.Update.t) =
     let open Deferred.Result.Let_syntax in
     let%bind app_state_id =
@@ -893,7 +1190,7 @@ module Zkapp_updates = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -910,7 +1207,7 @@ module Zkapp_balance_bounds = struct
 
   let table_name = "zkapp_balance_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (balance_bounds :
         Currency.Balance.t Mina_base.Zkapp_precondition.Closed_interval.t ) =
     let balance_lower_bound = Currency.Balance.to_string balance_bounds.lower in
@@ -921,7 +1218,7 @@ module Zkapp_balance_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -938,7 +1235,7 @@ module Zkapp_nonce_bounds = struct
 
   let table_name = "zkapp_nonce_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (nonce_bounds :
         Mina_numbers.Account_nonce.t
         Mina_base.Zkapp_precondition.Closed_interval.t ) =
@@ -950,7 +1247,7 @@ module Zkapp_nonce_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -985,7 +1282,7 @@ module Zkapp_account_precondition = struct
 
   let table_name = "zkapp_account_precondition"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (acct : Zkapp_precondition.Account.t) =
     let open Deferred.Result.Let_syntax in
     let%bind balance_id =
@@ -1034,7 +1331,7 @@ module Zkapp_account_precondition = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1051,7 +1348,7 @@ module Zkapp_token_id_bounds = struct
 
   let table_name = "zkapp_token_id_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (token_id_bounds :
         Token_id.t Mina_base.Zkapp_precondition.Closed_interval.t ) =
     let token_id_lower_bound = token_id_bounds.lower |> Token_id.to_string in
@@ -1062,7 +1359,7 @@ module Zkapp_token_id_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1079,7 +1376,7 @@ module Zkapp_timestamp_bounds = struct
 
   let table_name = "zkapp_timestamp_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (timestamp_bounds :
         Block_time.t Mina_base.Zkapp_precondition.Closed_interval.t ) =
     let timestamp_lower_bound =
@@ -1094,7 +1391,7 @@ module Zkapp_timestamp_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1111,7 +1408,7 @@ module Zkapp_length_bounds = struct
 
   let table_name = "zkapp_length_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (length_bounds :
         Unsigned.uint32 Mina_base.Zkapp_precondition.Closed_interval.t ) =
     let length_lower_bound = Unsigned.UInt32.to_int64 length_bounds.lower in
@@ -1122,7 +1419,7 @@ module Zkapp_length_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1139,7 +1436,7 @@ module Zkapp_amount_bounds = struct
 
   let table_name = "zkapp_amount_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (amount_bounds :
         Currency.Amount.t Mina_base.Zkapp_precondition.Closed_interval.t ) =
     let amount_lower_bound = Currency.Amount.to_string amount_bounds.lower in
@@ -1150,7 +1447,7 @@ module Zkapp_amount_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1167,7 +1464,7 @@ module Zkapp_global_slot_bounds = struct
 
   let table_name = "zkapp_global_slot_bounds"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (global_slot_bounds :
         Mina_numbers.Global_slot_since_genesis.t
         Mina_base.Zkapp_precondition.Closed_interval.t ) =
@@ -1185,7 +1482,7 @@ module Zkapp_global_slot_bounds = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1193,23 +1490,89 @@ module Zkapp_global_slot_bounds = struct
 end
 
 module Timing_info = struct
-  type t =
-    { account_identifier_id : int
-    ; initial_minimum_balance : string
-    ; cliff_time : int64
-    ; cliff_amount : string
-    ; vesting_period : int64
-    ; vesting_increment : string
-    }
-  [@@deriving hlist, fields]
+  module T = struct
+    type t =
+      { account_identifier_id : int
+      ; initial_minimum_balance : string
+      ; cliff_time : int64
+      ; cliff_amount : string
+      ; vesting_period : int64
+      ; vesting_increment : string
+      }
+    [@@deriving hlist, fields, compare, sexp, hash]
+  end
+
+  module With_id = struct
+    type t =
+      { id : int
+      ; account_identifier_id : int
+      ; initial_minimum_balance : string
+      ; cliff_time : int64
+      ; cliff_amount : string
+      ; vesting_period : int64
+      ; vesting_increment : string
+      }
+    [@@deriving hlist, fields, compare, sexp, hash]
+
+    let forget_id
+        { id = _
+        ; account_identifier_id
+        ; initial_minimum_balance
+        ; cliff_time
+        ; cliff_amount
+        ; vesting_period
+        ; vesting_increment
+        } =
+      { T.account_identifier_id
+      ; initial_minimum_balance
+      ; cliff_time
+      ; cliff_amount
+      ; vesting_period
+      ; vesting_increment
+      }
+  end
+
+  include T
 
   let typ =
     Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
       Caqti_type.[ int; string; int64; string; int64; string ]
 
+  let typ_with_id =
+    let open With_id in
+    Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
+      Caqti_type.[ int; int; string; int64; string; int64; string ]
+
   let table_name = "timing_info"
 
-  let find (module Conn : CONNECTION) (acc : Account.t) =
+  type local_copy = (t, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
+
+  let load (module Conn : Mina_caqti.CONNECTION) id =
+    Conn.find
+      (Mina_caqti.find_req Caqti_type.int typ
+         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
+      id
+
+  let load_opt (module Conn : Mina_caqti.CONNECTION) id =
+    Conn.find_opt
+      (Mina_caqti.find_opt_req Caqti_type.int typ
+         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
+      id
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () -> Hashtbl.create (module T))
+      ~local_copies ~typ:typ_with_id
+      ~query:
+        (sprintf {sql| SELECT %s FROM timing_info |sql}
+           (String.concat ~sep:"," With_id.Fields.names) )
+      ~load_elt:(fun t_to_id t ->
+        Hashtbl.add_exn t_to_id ~key:(With_id.forget_id t) ~data:t.id ;
+        Deferred.unit )
+
+  let find (module Conn : Mina_caqti.CONNECTION) (acc : Account.t) =
     let open Deferred.Result.Let_syntax in
     let%bind account_identifier_id =
       let account_id = Account_id.create acc.public_key acc.token_id in
@@ -1225,7 +1588,7 @@ module Timing_info = struct
          |sql} )
       account_identifier_id
 
-  let find_by_account_identifier_id_opt (module Conn : CONNECTION)
+  let find_by_account_identifier_id_opt (module Conn : Mina_caqti.CONNECTION)
       account_identifier_id =
     Conn.find_opt
       (find_opt_req Caqti_type.int typ
@@ -1237,8 +1600,9 @@ module Timing_info = struct
          |sql} )
       account_identifier_id
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) account_identifier_id
-      (timing : Account_timing.t) =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
+      account_identifier_id (timing : Account_timing.t) =
+    let%bind t_to_id = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let slot_to_int64 x =
       Mina_numbers.Global_slot_since_genesis.to_uint32 x
@@ -1269,60 +1633,41 @@ module Timing_info = struct
           ; vesting_increment = zero
           }
     in
-    match%bind
-      Conn.find_opt
-        (find_opt_req typ Caqti_type.int
-           {sql| SELECT id FROM timing_info
-                 WHERE account_identifier_id = ?
-                 AND initial_minimum_balance = ?
-                 AND cliff_time = ?
-                 AND cliff_amount = ?
-                 AND vesting_period = ?
-                 AND vesting_increment = ? |sql} )
-        values
-    with
+    match Hashtbl.find t_to_id values with
     | Some id ->
         return id
     | None ->
-        Conn.find
-          (find_req typ Caqti_type.int
-             {sql| INSERT INTO timing_info
+        let%map new_id =
+          Conn.find
+            (Mina_caqti.find_req typ Caqti_type.int
+               {sql| INSERT INTO timing_info
                     (account_identifier_id,initial_minimum_balance,
                      cliff_time, cliff_amount, vesting_period, vesting_increment)
                    VALUES (?, ?, ?, ?, ?, ?)
                    RETURNING id
              |sql} )
-          values
-
-  let load (module Conn : CONNECTION) id =
-    Conn.find
-      (find_req Caqti_type.int typ
-         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
-      id
-
-  let load_opt (module Conn : CONNECTION) id =
-    Conn.find_opt
-      (find_opt_req Caqti_type.int typ
-         (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
-      id
+            values
+        in
+        Hashtbl.add_exn t_to_id ~key:values ~data:new_id ;
+        new_id
 end
 
 module Snarked_ledger_hash = struct
-  let find (module Conn : CONNECTION) (t : Frozen_ledger_hash.t) =
+  let find (module Conn : Mina_caqti.CONNECTION) (t : Frozen_ledger_hash.t) =
     let hash = Frozen_ledger_hash.to_base58_check t in
     Conn.find
       (find_req Caqti_type.string Caqti_type.int
          "SELECT id FROM snarked_ledger_hashes WHERE value = ?" )
       hash
 
-  let find_by_id (module Conn : CONNECTION) id =
+  let find_by_id (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          "SELECT value FROM snarked_ledger_hashes WHERE id = ?" )
       id
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) (t : Frozen_ledger_hash.t)
-      =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
+      (t : Frozen_ledger_hash.t) =
     let open Deferred.Result.Let_syntax in
     let hash = Frozen_ledger_hash.to_base58_check t in
     match%bind
@@ -1339,7 +1684,7 @@ module Snarked_ledger_hash = struct
              "INSERT INTO snarked_ledger_hashes (value) VALUES (?) RETURNING id" )
           hash
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Caqti_type.string
          "SELECT value FROM snarked_ledger_hashes WHERE id = ?" )
@@ -1356,7 +1701,7 @@ module Zkapp_epoch_ledger = struct
 
   let table_name = "zkapp_epoch_ledger"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (epoch_ledger : _ Epoch_ledger.Poly.t) =
     let open Deferred.Result.Let_syntax in
     let%bind hash_id =
@@ -1375,7 +1720,7 @@ module Zkapp_epoch_ledger = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1399,7 +1744,7 @@ module Zkapp_epoch_data = struct
 
   let table_name = "zkapp_epoch_data"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (epoch_data : Mina_base.Zkapp_precondition.Protocol_state.Epoch_data.t) =
     let open Deferred.Result.Let_syntax in
     let%bind epoch_ledger_id =
@@ -1435,7 +1780,7 @@ module Zkapp_epoch_data = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1461,7 +1806,7 @@ module Zkapp_network_precondition = struct
 
   let table_name = "zkapp_network_precondition"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (ps : Mina_base.Zkapp_precondition.Protocol_state.t) =
     let open Deferred.Result.Let_syntax in
     let%bind snarked_ledger_hash_id =
@@ -1510,7 +1855,7 @@ module Zkapp_network_precondition = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1546,7 +1891,7 @@ module Zkapp_events = struct
      7. use "M'" and the list of list of field_ids to compute the list of field_array_ids
      8. insert the list of field_arrays
   *)
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (events : Account_update.Body.Events'.t) =
     let open Deferred.Result.Let_syntax in
     let%bind field_array_id_list =
@@ -1602,7 +1947,7 @@ module Zkapp_events = struct
       (module Conn)
       field_array_id_list
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int Mina_caqti.array_int_typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:[ "element_ids" ]) )
@@ -1653,7 +1998,7 @@ module Zkapp_account_update_body = struct
 
   let table_name = "zkapp_account_update_body"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (body : Account_update.Body.Simple.t) =
     let open Deferred.Result.Let_syntax in
     let account_identifier = Account_id.create body.public_key body.token_id in
@@ -1754,7 +2099,7 @@ module Zkapp_account_update_body = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1769,7 +2114,7 @@ module Zkapp_account_update = struct
 
   let table_name = "zkapp_account_update"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (account_update : Account_update.Simple.t) =
     let open Deferred.Result.Let_syntax in
     let%bind body_id =
@@ -1785,7 +2130,7 @@ module Zkapp_account_update = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1807,7 +2152,7 @@ module Zkapp_fee_payer_body = struct
 
   let table_name = "zkapp_fee_payer_body"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (body : Account_update.Body.Fee_payer.t) =
     let open Deferred.Result.Let_syntax in
     let%bind public_key_id =
@@ -1829,7 +2174,7 @@ module Zkapp_fee_payer_body = struct
       (module Conn)
       value
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1858,7 +2203,7 @@ module Epoch_data = struct
 
   let table_name = "epoch_data"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       (t : Mina_base.Epoch_data.Value.t) =
     let open Deferred.Result.Let_syntax in
     let Mina_base.Epoch_ledger.Poly.{ hash; total_currency } =
@@ -1886,7 +2231,7 @@ module Epoch_data = struct
       ; epoch_length
       }
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1926,14 +2271,14 @@ module User_command = struct
 
     let table_name = "user_commands"
 
-    let find (module Conn : CONNECTION) ~(transaction_hash : Transaction_hash.t)
-        ~v1_transaction_hash =
+    let find (module Conn : Mina_caqti.CONNECTION)
+        ~(transaction_hash : Transaction_hash.t) ~v1_transaction_hash =
       Conn.find_opt
         (find_opt_req Caqti_type.string Caqti_type.int
            (Mina_caqti.select_cols ~select:"id" ~table_name ~cols:[ "hash" ] ()) )
         (txn_hash_to_base58_check transaction_hash ~v1_transaction_hash)
 
-    let load (module Conn : CONNECTION) ~(id : int) =
+    let load (module Conn : Mina_caqti.CONNECTION) ~(id : int) =
       Conn.find
         (find_req Caqti_type.int typ
            (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -1941,7 +2286,7 @@ module User_command = struct
 
     type balance_public_key_ids = { fee_payer_id : int; receiver_id : int }
 
-    let add_account_ids_if_don't_exist (module Conn : CONNECTION)
+    let add_account_ids_if_don't_exist (module Conn : Mina_caqti.CONNECTION)
         (t : Signed_command.t) =
       let open Deferred.Result.Let_syntax in
       let%bind fee_payer_id =
@@ -1954,8 +2299,9 @@ module User_command = struct
       in
       { fee_payer_id; receiver_id }
 
-    let add_if_doesn't_exist ?(via = `Ident) (module Conn : CONNECTION)
-        (t : Signed_command.t) ~v1_transaction_hash =
+    let add_if_doesn't_exist ?(via = `Ident)
+        (module Conn : Mina_caqti.CONNECTION) (t : Signed_command.t)
+        ~v1_transaction_hash =
       let open Deferred.Result.Let_syntax in
       let transaction_hash = Transaction_hash.hash_command (Signed_command t) in
       match%bind find (module Conn) ~transaction_hash ~v1_transaction_hash with
@@ -2006,7 +2352,7 @@ module User_command = struct
                 |> txn_hash_to_base58_check ~v1_transaction_hash
             }
 
-    let add_extensional_if_doesn't_exist (module Conn : CONNECTION)
+    let add_extensional_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
         ?(v1_transaction_hash = false) (user_cmd : Extensional.User_command.t) =
       let open Deferred.Result.Let_syntax in
       match%bind
@@ -2064,7 +2410,7 @@ module User_command = struct
 
     let table_name = "zkapp_commands"
 
-    let find_opt (module Conn : CONNECTION)
+    let find_opt (module Conn : Mina_caqti.CONNECTION)
         ~(transaction_hash : Transaction_hash.t) =
       Conn.find_opt
         ( find_opt_req Caqti_type.string Caqti_type.int
@@ -2072,13 +2418,14 @@ module User_command = struct
         )
         (Transaction_hash.to_base58_check transaction_hash)
 
-    let load (module Conn : CONNECTION) id =
+    let load (module Conn : Mina_caqti.CONNECTION) id =
       Conn.find
         ( find_req Caqti_type.int typ
         @@ Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names )
         id
 
-    let add_if_doesn't_exist (module Conn : CONNECTION) (ps : Zkapp_command.t) =
+    let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
+        (ps : Zkapp_command.t) =
       let open Deferred.Result.Let_syntax in
       let zkapp_command = Zkapp_command.to_simple ps in
       let%bind zkapp_fee_payer_body_id =
@@ -2147,8 +2494,9 @@ module Internal_command = struct
 
   let table_name = "internal_commands"
 
-  let find_opt (module Conn : CONNECTION) ~(v1_transaction_hash : bool)
-      ~(transaction_hash : Transaction_hash.t) ~(command_type : string) =
+  let find_opt (module Conn : Mina_caqti.CONNECTION)
+      ~(v1_transaction_hash : bool) ~(transaction_hash : Transaction_hash.t)
+      ~(command_type : string) =
     Conn.find_opt
       (find_opt_req
          Caqti_type.(t2 string string)
@@ -2160,13 +2508,13 @@ module Internal_command = struct
       ( txn_hash_to_base58_check ~v1_transaction_hash transaction_hash
       , command_type )
 
-  let load (module Conn : CONNECTION) ~(id : int) =
+  let load (module Conn : Mina_caqti.CONNECTION) ~(id : int) =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
       id
 
-  let add_extensional_if_doesn't_exist (module Conn : CONNECTION)
+  let add_extensional_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       ?(v1_transaction_hash = false)
       (internal_cmd : Extensional.Internal_command.t) =
     let open Deferred.Result.Let_syntax in
@@ -2231,7 +2579,7 @@ module Fee_transfer = struct
     let rep = Caqti_type.(t4 string int int64 string) in
     Caqti_type.custom ~encode ~decode rep
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       ?(v1_transaction_hash = false) (t : Fee_transfer.Single.t)
       (kind : [ `Normal | `Via_coinbase ]) =
     let open Deferred.Result.Let_syntax in
@@ -2281,7 +2629,7 @@ module Coinbase = struct
     let rep = Caqti_type.(t4 string int int64 string) in
     Caqti_type.custom ~encode ~decode rep
 
-  let add_if_doesn't_exist (module Conn : CONNECTION)
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       ?(v1_transaction_hash = false) (t : Coinbase.t) =
     let open Deferred.Result.Let_syntax in
     let transaction_hash = Transaction_hash.hash_coinbase t in
@@ -2331,8 +2679,8 @@ module Block_and_internal_command = struct
     Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
       Caqti_type.[ int; int; int; int; string; option string ]
 
-  let add (module Conn : CONNECTION) ~block_id ~internal_command_id ~sequence_no
-      ~secondary_sequence_no ~status
+  let add (module Conn : Mina_caqti.CONNECTION) ~block_id ~internal_command_id
+      ~sequence_no ~secondary_sequence_no ~status
       ~(failure_reason : Transaction_status.Failure.t option) =
     let failure_reason =
       Option.map ~f:Transaction_status.Failure.to_string failure_reason
@@ -2356,7 +2704,7 @@ module Block_and_internal_command = struct
       ; failure_reason
       }
 
-  let find (module Conn : CONNECTION) ~block_id ~internal_command_id
+  let find (module Conn : Mina_caqti.CONNECTION) ~block_id ~internal_command_id
       ~sequence_no ~secondary_sequence_no =
     Conn.find_opt
       (find_opt_req
@@ -2370,7 +2718,7 @@ module Block_and_internal_command = struct
          |sql} )
       (block_id, internal_command_id, sequence_no, secondary_sequence_no)
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) ~block_id
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) ~block_id
       ~internal_command_id ~sequence_no ~secondary_sequence_no ~status
       ~failure_reason =
     let open Deferred.Result.Let_syntax in
@@ -2387,7 +2735,7 @@ module Block_and_internal_command = struct
           ~block_id ~internal_command_id ~sequence_no ~secondary_sequence_no
           ~status ~failure_reason
 
-  let load (module Conn : CONNECTION) ~block_id ~internal_command_id
+  let load (module Conn : Mina_caqti.CONNECTION) ~block_id ~internal_command_id
       ~sequence_no ~secondary_sequence_no =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.find
@@ -2421,8 +2769,8 @@ module Block_and_signed_command = struct
 
   let table_name = "blocks_user_commands"
 
-  let add (module Conn : CONNECTION) ~block_id ~user_command_id ~sequence_no
-      ~status ~failure_reason =
+  let add (module Conn : Mina_caqti.CONNECTION) ~block_id ~user_command_id
+      ~sequence_no ~status ~failure_reason =
     let failure_reason =
       Option.map ~f:Transaction_status.Failure.to_string failure_reason
     in
@@ -2438,8 +2786,8 @@ module Block_and_signed_command = struct
          |sql} )
       { block_id; user_command_id; sequence_no; status; failure_reason }
 
-  let add_with_status (module Conn : CONNECTION) ~block_id ~user_command_id
-      ~sequence_no ~(status : Transaction_status.t) =
+  let add_with_status (module Conn : Mina_caqti.CONNECTION) ~block_id
+      ~user_command_id ~sequence_no ~(status : Transaction_status.t) =
     let status_str, failure_reason =
       match status with
       | Applied ->
@@ -2452,8 +2800,8 @@ module Block_and_signed_command = struct
       (module Conn)
       ~block_id ~user_command_id ~sequence_no ~status:status_str ~failure_reason
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) ~block_id ~user_command_id
-      ~sequence_no ~(status : string) ~failure_reason =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) ~block_id
+      ~user_command_id ~sequence_no ~(status : string) ~failure_reason =
     let open Deferred.Result.Let_syntax in
     match%bind
       Conn.find_opt
@@ -2474,7 +2822,8 @@ module Block_and_signed_command = struct
           (module Conn)
           ~block_id ~user_command_id ~sequence_no ~status ~failure_reason
 
-  let load (module Conn : CONNECTION) ~block_id ~user_command_id ~sequence_no =
+  let load (module Conn : Mina_caqti.CONNECTION) ~block_id ~user_command_id
+      ~sequence_no =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.find
       (find_req
@@ -2499,7 +2848,8 @@ module Zkapp_account_update_failures = struct
 
   let table_name = "zkapp_account_update_failures"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) index failures =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) index failures
+      =
     let failures =
       List.map failures ~f:Transaction_status.Failure.to_string |> Array.of_list
     in
@@ -2510,7 +2860,7 @@ module Zkapp_account_update_failures = struct
       (module Conn)
       { index; failures }
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name
@@ -2534,7 +2884,7 @@ module Block_and_zkapp_command = struct
     Mina_caqti.Type_spec.custom_type ~to_hlist ~of_hlist
       Caqti_type.[ int; int; int; string; option Mina_caqti.array_int_typ ]
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) ~block_id
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) ~block_id
       ~zkapp_command_id ~sequence_no ~status
       ~(failure_reasons : Transaction_status.Failure.Collection.Display.t option)
       =
@@ -2575,7 +2925,8 @@ module Block_and_zkapp_command = struct
       (module Conn)
       { block_id; zkapp_command_id; sequence_no; status; failure_reasons_ids }
 
-  let load (module Conn : CONNECTION) ~block_id ~zkapp_command_id ~sequence_no =
+  let load (module Conn : Mina_caqti.CONNECTION) ~block_id ~zkapp_command_id
+      ~sequence_no =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.find
       (find_req
@@ -2586,7 +2937,7 @@ module Block_and_zkapp_command = struct
             () ) )
       (block_id, zkapp_command_id, sequence_no)
 
-  let all_from_block (module Conn : CONNECTION) ~block_id =
+  let all_from_block (module Conn : Mina_caqti.CONNECTION) ~block_id =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.collect_list
       (collect_req Caqti_type.int typ
@@ -2613,7 +2964,7 @@ module Zkapp_account = struct
 
   let table_name = "zkapp_accounts"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) zkapp_account =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) zkapp_account =
     let open Deferred.Result.Let_syntax in
     let ({ app_state
          ; verification_key
@@ -2659,7 +3010,7 @@ module Zkapp_account = struct
       ; zkapp_uri_id
       }
 
-  let load (module Conn : CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name ~cols:Fields.names) )
@@ -2702,7 +3053,27 @@ module Accounts_accessed = struct
 
   let table_name = "accounts_accessed"
 
-  let find_opt (module Conn : CONNECTION) ~block_id ~account_identifier_id =
+  type local_copy = (t, int) Hashtbl.t
+
+  let local_copies = Hashtbl.create (module String)
+
+  let load_copy =
+    load_copy'
+      ~default:(fun () ->
+        Hash_set.create
+          ( module struct
+            type t = int * int [@@deriving compare, sexp, hash]
+          end ) )
+      ~local_copies
+      ~typ:Caqti_type.(t2 int int)
+      ~query:
+        {sql| SELECT block_id,account_identifier_id FROM accounts_accessed |sql}
+      ~load_elt:(fun exists_index key ->
+        Hash_set.add exists_index key ;
+        Deferred.unit )
+
+  let find_opt (module Conn : Mina_caqti.CONNECTION) ~block_id
+      ~account_identifier_id =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.find_opt
       (find_opt_req
@@ -2717,72 +3088,71 @@ module Accounts_accessed = struct
             comma_cols table_name ) )
       (block_id, account_identifier_id)
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) block_id
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) block_id
       (ledger_index, (account : Account.t)) =
+    let%bind exists_index = load_copy (module Conn) in
     let open Deferred.Result.Let_syntax in
     let account_id = Account_id.create account.public_key account.token_id in
     let%bind account_identifier_id =
       Account_identifiers.add_if_doesn't_exist (module Conn) account_id
     in
-    match%bind find_opt (module Conn) ~block_id ~account_identifier_id with
-    | Some result ->
-        return (result.block_id, result.account_identifier_id)
-    | None ->
-        let%bind token_symbol_id =
-          Token_symbols.add_if_doesn't_exist (module Conn) account.token_symbol
-        in
-        let balance = Currency.Balance.to_string account.balance in
-        let nonce =
-          account.nonce |> Account.Nonce.to_uint32 |> Unsigned.UInt32.to_int64
-        in
-        let receipt_chain_hash =
-          account.receipt_chain_hash |> Receipt.Chain_hash.to_base58_check
-        in
-        let%bind delegate_id =
-          Mina_caqti.add_if_some
-            (Public_key.add_if_doesn't_exist (module Conn))
-            account.delegate
-        in
-        let%bind voting_for_id =
-          Voting_for.add_if_doesn't_exist (module Conn) account.voting_for
-        in
-        let%bind timing_id =
-          Timing_info.add_if_doesn't_exist
-            (module Conn)
-            account_identifier_id account.timing
-        in
-        let%bind permissions_id =
-          Zkapp_permissions.add_if_doesn't_exist
-            (module Conn)
-            account.permissions
-        in
-        let%bind zkapp_id =
-          Mina_caqti.add_if_some
-            (Zkapp_account.add_if_doesn't_exist (module Conn))
-            account.zkapp
-        in
-        let account_accessed : t =
-          { ledger_index
-          ; block_id
-          ; account_identifier_id
-          ; token_symbol_id
-          ; balance
-          ; nonce
-          ; receipt_chain_hash
-          ; delegate_id
-          ; voting_for_id
-          ; timing_id
-          ; permissions_id
-          ; zkapp_id
-          }
-        in
-        Mina_caqti.select_insert_into_cols
-          ~select:("block_id,account_identifier_id", Caqti_type.(t2 int int))
-          ~table_name ~cols:(Fields.names, typ)
+    if Hash_set.mem exists_index (block_id, account_identifier_id) then
+      return (block_id, account_identifier_id)
+    else
+      let%bind token_symbol_id =
+        Token_symbols.add_if_doesn't_exist (module Conn) account.token_symbol
+      in
+      let balance = Currency.Balance.to_string account.balance in
+      let nonce =
+        account.nonce |> Account.Nonce.to_uint32 |> Unsigned.UInt32.to_int64
+      in
+      let receipt_chain_hash =
+        account.receipt_chain_hash |> Receipt.Chain_hash.to_base58_check
+      in
+      let%bind delegate_id =
+        Mina_caqti.add_if_some
+          (Public_key.add_if_doesn't_exist (module Conn))
+          account.delegate
+      in
+      let%bind voting_for_id =
+        Voting_for.add_if_doesn't_exist (module Conn) account.voting_for
+      in
+      let%bind timing_id =
+        Timing_info.add_if_doesn't_exist
           (module Conn)
-          account_accessed
+          account_identifier_id account.timing
+      in
+      let%bind permissions_id =
+        Zkapp_permissions.add_if_doesn't_exist (module Conn) account.permissions
+      in
+      let%bind zkapp_id =
+        Mina_caqti.add_if_some
+          (Zkapp_account.add_if_doesn't_exist (module Conn))
+          account.zkapp
+      in
+      let account_accessed : t =
+        { ledger_index
+        ; block_id
+        ; account_identifier_id
+        ; token_symbol_id
+        ; balance
+        ; nonce
+        ; receipt_chain_hash
+        ; delegate_id
+        ; voting_for_id
+        ; timing_id
+        ; permissions_id
+        ; zkapp_id
+        }
+      in
+      Hash_set.add exists_index (block_id, account_identifier_id) ;
+      Mina_caqti.insert_assuming_new
+        ~select:("block_id,account_identifier_id", Caqti_type.(t2 int int))
+        ~table_name ~cols:(Fields.names, typ)
+        (module Conn)
+        account_accessed
 
-  let add_accounts_if_don't_exist (module Conn : CONNECTION) block_id
+  let add_accounts_if_don't_exist (module Conn : Mina_caqti.CONNECTION) block_id
       (accounts : (int * Account.t) list) =
     let%map results =
       Deferred.List.map accounts ~f:(fun account ->
@@ -2790,7 +3160,7 @@ module Accounts_accessed = struct
     in
     Result.all results
 
-  let all_from_block (module Conn : CONNECTION) block_id =
+  let all_from_block (module Conn : Mina_caqti.CONNECTION) block_id =
     let comma_cols = String.concat Fields.names ~sep:"," in
     Conn.collect_list
       (collect_req Caqti_type.int typ
@@ -2810,8 +3180,8 @@ module Accounts_created = struct
 
   let table_name = "accounts_created"
 
-  let add_if_doesn't_exist (module Conn : CONNECTION) block_id account_id
-      creation_fee =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) block_id
+      account_id creation_fee =
     let open Deferred.Result.Let_syntax in
     let%bind account_identifier_id =
       Account_identifiers.add_if_doesn't_exist (module Conn) account_id
@@ -2823,15 +3193,15 @@ module Accounts_created = struct
       (module Conn)
       { block_id; account_identifier_id; creation_fee }
 
-  let add_accounts_created_if_don't_exist (module Conn : CONNECTION) block_id
-      accounts_created =
+  let add_accounts_created_if_don't_exist (module Conn : Mina_caqti.CONNECTION)
+      block_id accounts_created =
     let%map results =
       Deferred.List.map accounts_created ~f:(fun (pk, creation_fee) ->
           add_if_doesn't_exist (module Conn) block_id pk creation_fee )
     in
     Result.all results
 
-  let all_from_block (module Conn : CONNECTION) block_id =
+  let all_from_block (module Conn : Mina_caqti.CONNECTION) block_id =
     Conn.collect_list
       (collect_req Caqti_type.int typ
          {sql| SELECT block_id, account_identifier_id, creation_fee
@@ -2899,18 +3269,19 @@ module Block = struct
          "SELECT id FROM blocks WHERE state_hash = ?" )
       (State_hash.to_base58_check state_hash)
 
-  let find (module Conn : CONNECTION) = make_finder Conn.find find_req
+  let find (module Conn : Mina_caqti.CONNECTION) =
+    make_finder Conn.find Mina_caqti.find_req
 
-  let find_opt (module Conn : CONNECTION) =
-    make_finder Conn.find_opt find_opt_req
+  let find_opt (module Conn : Mina_caqti.CONNECTION) =
+    make_finder Conn.find_opt Mina_caqti.find_opt_req
 
-  let load (module Conn : CONNECTION) ~id =
+  let load (module Conn : Mina_caqti.CONNECTION) ~id =
     Conn.find
       (find_req Caqti_type.int typ
          (Mina_caqti.select_cols_from_id ~table_name:"blocks" ~cols:Fields.names) )
       id
 
-  let add_parts_if_doesn't_exist (module Conn : CONNECTION)
+  let add_parts_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION)
       ~constraint_constants ~protocol_state ~staged_ledger_diff
       ~protocol_version ~proposed_protocol_version ~hash ~v1_transaction_hash =
     let open Deferred.Result.Let_syntax in
@@ -3331,7 +3702,7 @@ module Block = struct
 
   (* NB: this batching logic an lead to partial writes; it is acceptable to be used with the
      migration tool, but not acceptable to be used with the archive node in its current form *)
-  let add_from_extensional_batch (module Conn : CONNECTION)
+  let add_from_extensional_batch (module Conn : Mina_caqti.CONNECTION)
       ?(v1_transaction_hash = false) (blocks : Extensional.Block.t list) =
     let open Deferred.Result.Let_syntax in
     (* zkapps are currently unsupported in the batch implementation of this function *)
@@ -4059,7 +4430,7 @@ module Block = struct
 
     return ()
 
-  let add_from_extensional (module Conn : CONNECTION)
+  let add_from_extensional (module Conn : Mina_caqti.CONNECTION)
       ?(v1_transaction_hash = false) (block : Extensional.Block.t) =
     let open Deferred.Result.Let_syntax in
     let%bind block_id =
@@ -4276,7 +4647,7 @@ module Block = struct
     in
     return block_id
 
-  let set_parent_id_if_null (module Conn : CONNECTION) ~parent_hash
+  let set_parent_id_if_null (module Conn : Mina_caqti.CONNECTION) ~parent_hash
       ~(parent_id : int) =
     Conn.exec
       (exec_req
@@ -4287,7 +4658,8 @@ module Block = struct
          |sql} )
       (parent_id, State_hash.to_base58_check parent_hash)
 
-  let get_subchain (module Conn : CONNECTION) ~start_block_id ~end_block_id =
+  let get_subchain (module Conn : Mina_caqti.CONNECTION) ~start_block_id
+      ~end_block_id =
     (* derive query from type `t` *)
     let concat = String.concat ~sep:"," in
     let columns_with_id = concat ("id" :: Fields.names) in
@@ -4321,14 +4693,15 @@ module Block = struct
             columns_with_id b_columns_with_id columns ) )
       (end_block_id, start_block_id)
 
-  let get_highest_canonical_block_opt (module Conn : CONNECTION) =
+  let get_highest_canonical_block_opt (module Conn : Mina_caqti.CONNECTION) =
     Conn.find_opt
       (find_opt_req Caqti_type.unit
          Caqti_type.(t2 int int64)
          "SELECT id,height FROM blocks WHERE chain_status='canonical' ORDER BY \
           height DESC LIMIT 1" )
 
-  let get_nearest_canonical_block_above (module Conn : CONNECTION) height =
+  let get_nearest_canonical_block_above (module Conn : Mina_caqti.CONNECTION)
+      height =
     Conn.find
       (find_req Caqti_type.int64
          Caqti_type.(t2 int int64)
@@ -4336,7 +4709,8 @@ module Block = struct
           height > ? ORDER BY height ASC LIMIT 1" )
       height
 
-  let get_nearest_canonical_block_below (module Conn : CONNECTION) height =
+  let get_nearest_canonical_block_below (module Conn : Mina_caqti.CONNECTION)
+      height =
     Conn.find
       (find_req Caqti_type.int64
          Caqti_type.(t2 int int64)
@@ -4344,13 +4718,14 @@ module Block = struct
           height < ? ORDER BY height DESC LIMIT 1" )
       height
 
-  let mark_as_canonical (module Conn : CONNECTION) ~state_hash =
+  let mark_as_canonical (module Conn : Mina_caqti.CONNECTION) ~state_hash =
     Conn.exec
       (exec_req Caqti_type.string
          "UPDATE blocks SET chain_status='canonical' WHERE state_hash = ?" )
       state_hash
 
-  let mark_as_orphaned (module Conn : CONNECTION) ~state_hash ~height =
+  let mark_as_orphaned (module Conn : Mina_caqti.CONNECTION) ~state_hash ~height
+      =
     Conn.exec
       (exec_req
          Caqti_type.(t2 string int64)
@@ -4361,7 +4736,7 @@ module Block = struct
       (state_hash, height)
 
   (* update chain_status for blocks now known to be canonical or orphaned *)
-  let update_chain_status (module Conn : CONNECTION) ~block_id =
+  let update_chain_status (module Conn : Mina_caqti.CONNECTION) ~block_id =
     let open Deferred.Result.Let_syntax in
     match%bind get_highest_canonical_block_opt (module Conn) () with
     | None ->
@@ -4433,7 +4808,7 @@ module Block = struct
           Deferred.Result.return ()
 
   let delete_if_older_than ?height ?num_blocks ?timestamp
-      (module Conn : CONNECTION) =
+      (module Conn : Mina_caqti.CONNECTION) =
     let open Deferred.Result.Let_syntax in
     let%bind height =
       match (height, num_blocks) with
@@ -4549,8 +4924,8 @@ let add_block_aux ?(retries = 3) ~logger ~pool ~add_block ~hash
             ()
         | Some acct_id ->
             Token_owners.add_if_doesn't_exist token_id acct_id ) ;
-    Caqti_async.Pool.use
-      (fun (module Conn : CONNECTION) ->
+    Mina_caqti.Pool.use
+      (fun (module Conn : Mina_caqti.CONNECTION) ->
         let%bind res =
           let open Deferred.Result.Let_syntax in
           let%bind () = Conn.start () in
@@ -4561,7 +4936,7 @@ let add_block_aux ?(retries = 3) ~logger ~pool ~add_block ~hash
             O1trace.thread "archive_processor.add_block"
             @@ fun () ->
             Metrics.time ~label:"add_block"
-            @@ fun () -> add_block (module Conn : CONNECTION) block
+            @@ fun () -> add_block (module Conn : Mina_caqti.CONNECTION) block
           in
           (* if an existing block has a parent hash that's for the block just added,
              set its parent id
@@ -4616,8 +4991,8 @@ let add_block_aux ?(retries = 3) ~logger ~pool ~add_block ~hash
                     ] ;
                 let%bind.Deferred.Result () = Conn.start () in
                 match%bind
-                  Caqti_async.Pool.use
-                    (fun (module Conn : CONNECTION) ->
+                  Mina_caqti.Pool.use
+                    (fun (module Conn : Mina_caqti.CONNECTION) ->
                       Accounts_accessed.add_accounts_if_don't_exist
                         (module Conn)
                         block_id accounts_accessed )
@@ -4642,8 +5017,8 @@ let add_block_aux ?(retries = 3) ~logger ~pool ~add_block ~hash
                           , `Int (List.length accounts_accessed) )
                         ] ;
                     match%bind
-                      Caqti_async.Pool.use
-                        (fun (module Conn : CONNECTION) ->
+                      Mina_caqti.Pool.use
+                        (fun (module Conn : Mina_caqti.CONNECTION) ->
                           Accounts_created.add_accounts_created_if_don't_exist
                             (module Conn)
                             block_id accounts_created )
@@ -4780,8 +5155,8 @@ let add_genesis_accounts ~logger ~(runtime_config_opt : Runtime_config.t option)
             With_hash.{ data = block; hash = the_hash }
           in
           let add_accounts () =
-            Caqti_async.Pool.use
-              (fun (module Conn : CONNECTION) ->
+            Mina_caqti.Pool.use
+              (fun (module Conn : Mina_caqti.CONNECTION) ->
                 let%bind.Deferred.Result genesis_block_id =
                   Block.add_if_doesn't_exist
                     (module Conn)
@@ -4924,13 +5299,7 @@ let setup_server ~metrics_server_port ~constraint_constants ~logger
           Strict_pipe.Writer.write extensional_block_writer extensional_block )
     ]
   in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:30 ()))
-      postgres_address
-  with
+  match Mina_caqti.connect_pool ~max_size:128 postgres_address with
   | Error e ->
       [%log error]
         "Failed to create a Caqti pool for Postgresql, see error: $error"
diff --git a/src/app/archive/lib/test.ml b/src/app/archive/lib/test.ml
index 7795a5817f..6f31ad3523 100644
--- a/src/app/archive/lib/test.ml
+++ b/src/app/archive/lib/test.ml
@@ -37,13 +37,13 @@ let%test_module "Archive node unit tests" =
         @@ fun () ->
         match%map Caqti_async.connect archive_uri with
         | Ok conn ->
-            conn
+            Mina_caqti.wrap_conn ~source:archive_uri conn
         | Error e ->
             failwith @@ Caqti_error.show e )
 
     let conn_pool_lazy =
       lazy
-        ( match Caqti_async.connect_pool archive_uri with
+        ( match Mina_caqti.connect_pool archive_uri with
         | Ok pool ->
             pool
         | Error e ->
@@ -312,7 +312,7 @@ let%test_module "Archive node unit tests" =
           match%map
             Mina_caqti.deferred_result_list_fold breadcrumbs ~init:()
               ~f:(fun () breadcrumb ->
-                Caqti_async.Pool.use
+                Mina_caqti.Pool.use
                   (fun conn ->
                     let open Deferred.Result.Let_syntax in
                     match%bind
diff --git a/src/app/archive_blocks/archive_blocks.ml b/src/app/archive_blocks/archive_blocks.ml
index caa4203939..a2934a6184 100644
--- a/src/app/archive_blocks/archive_blocks.ml
+++ b/src/app/archive_blocks/archive_blocks.ml
@@ -20,7 +20,7 @@ let main ~archive_uri ~precomputed ~extensional ~success_file ~failure_file
   if Bool.equal precomputed extensional then
     failwith "Must provide exactly one of -precomputed and -extensional" ;
   let logger = Logger.create () in
-  match Caqti_async.connect_pool archive_uri with
+  match Mina_caqti.connect_pool archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/app/berkeley_account_tables/berkeley_account_tables.ml b/src/app/berkeley_account_tables/berkeley_account_tables.ml
index a32ef59e4d..01d4912c28 100644
--- a/src/app/berkeley_account_tables/berkeley_account_tables.ml
+++ b/src/app/berkeley_account_tables/berkeley_account_tables.ml
@@ -50,7 +50,7 @@ type output =
 
 module type Get_command_ids = sig
   val run :
-       Caqti_async.connection
+       (module Mina_caqti.CONNECTION)
     -> state_hash:string
     -> start_slot:int64
     -> (int list, [> Caqti_error.call_or_retrieve ]) Deferred.Result.t
@@ -174,7 +174,7 @@ let get_slot_hashes slot = Hashtbl.find global_slot_hashes_tbl slot
 
 let process_block_infos_of_state_hash ~logger pool ~state_hash ~start_slot ~f =
   match%bind
-    Caqti_async.Pool.use
+    Mina_caqti.Pool.use
       (fun db -> Sql.Block_info.run db ~state_hash ~start_slot)
       pool
   with
@@ -521,8 +521,8 @@ let get_parent_state_view ~pool block_id =
   in
   return state_view
 
-let zkapp_command_to_transaction ~logger ~pool (cmd : Sql.Zkapp_command.t) :
-    Mina_transaction.Transaction.t Deferred.t =
+let zkapp_command_to_transaction ~logger ~source ~pool
+    (cmd : Sql.Zkapp_command.t) : Mina_transaction.Transaction.t Deferred.t =
   let query_db = Mina_caqti.query pool in
   (* use dummy authorizations *)
   let%bind (fee_payer : Account_update.Fee_payer.t) =
@@ -543,7 +543,7 @@ let zkapp_command_to_transaction ~logger ~pool (cmd : Sql.Zkapp_command.t) :
           query_db ~f:(fun db -> Processor.Zkapp_account_update.load db id)
         in
         let%map body =
-          Archive_lib.Load_data.get_account_update_body ~pool body_id
+          Archive_lib.Load_data.get_account_update_body ~source ~pool body_id
         in
         let (authorization : Control.t) =
           match body.authorization_kind with
@@ -641,13 +641,7 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
              msg )
   in
   let archive_uri = Uri.of_string archive_uri in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:30 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
@@ -787,7 +781,7 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
       (* end mutable state *)
       let get_command_ids (module Command_ids : Get_command_ids) name =
         match%bind
-          Caqti_async.Pool.use
+          Mina_caqti.Pool.use
             (fun db ->
               Command_ids.run db ~state_hash:target_state_hash
                 ~start_slot:input.start_slot_since_genesis )
@@ -823,7 +817,7 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
         Deferred.List.map internal_cmd_ids ~f:(fun id ->
             let open Deferred.Let_syntax in
             match%map
-              Caqti_async.Pool.use
+              Mina_caqti.Pool.use
                 (fun db ->
                   Sql.Internal_command.run db
                     ~start_slot:input.start_slot_since_genesis
@@ -880,7 +874,7 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
         Deferred.List.map user_cmd_ids ~f:(fun id ->
             let open Deferred.Let_syntax in
             match%map
-              Caqti_async.Pool.use (fun db -> Sql.User_command.run db id) pool
+              Mina_caqti.Pool.use (fun db -> Sql.User_command.run db id) pool
             with
             | Ok [] ->
                 failwithf "Expected at least one user command with id %d" id ()
@@ -911,7 +905,7 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
         Deferred.List.map zkapp_cmd_ids ~f:(fun id ->
             let open Deferred.Let_syntax in
             match%map
-              Caqti_async.Pool.use (fun db -> Sql.Zkapp_command.run db id) pool
+              Mina_caqti.Pool.use (fun db -> Sql.Zkapp_command.run db id) pool
             with
             | Ok [] ->
                 failwithf "Expected at least one zkApp command with id %d" id ()
@@ -1416,7 +1410,9 @@ let main ~input_file ~output_file_opt ~archive_uri ~continue_on_error
               check_for_complete_block
                 ~cmd_global_slot_since_genesis:zkc.global_slot_since_genesis
             in
-            let%bind txn = zkapp_command_to_transaction ~logger ~pool zkc in
+            let%bind txn =
+              zkapp_command_to_transaction ~logger ~pool ~source zkc
+            in
             apply_commands ~block_txns:(txn :: block_txns)
               ~last_global_slot_since_genesis:zkc.global_slot_since_genesis
               ~last_block_id:zkc.block_id internal_cmds user_cmds zkcs
diff --git a/src/app/berkeley_migration/berkeley_migration.ml b/src/app/berkeley_migration/berkeley_migration.ml
index b03f8fc40a..dcba5ef86b 100644
--- a/src/app/berkeley_migration/berkeley_migration.ml
+++ b/src/app/berkeley_migration/berkeley_migration.ml
@@ -2,7 +2,6 @@
 
 open Core_kernel
 open Async
-open Caqti_async
 
 (* before running this program for the first time, import the berkeley schema to the
    migrated database name
@@ -67,7 +66,7 @@ let mainnet_block_to_extensional_batch ~logger ~mainnet_pool ~precomputed_blocks
   let query_mainnet_db ~f = Mina_caqti.query ~f mainnet_pool in
   [%log debug] "Fetching transaction sequence from prior database" ;
   let%bind block_user_cmds =
-    query_mainnet_db ~f:(fun (module Conn : CONNECTION) ->
+    query_mainnet_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
         Conn.collect_list
           (Mina_caqti.collect_req Caqti_type.unit
              (Caqti_type.t2 Sql.Mainnet.User_command.typ
@@ -85,7 +84,7 @@ let mainnet_block_to_extensional_batch ~logger ~mainnet_pool ~precomputed_blocks
           () )
   in
   let%bind block_internal_cmds =
-    query_mainnet_db ~f:(fun (module Conn : CONNECTION) ->
+    query_mainnet_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
         Conn.collect_list
           (Mina_caqti.collect_req Caqti_type.unit
              (Caqti_type.t2 Sql.Mainnet.Internal_command.typ
@@ -117,7 +116,7 @@ let mainnet_block_to_extensional_batch ~logger ~mainnet_pool ~precomputed_blocks
   let%bind public_keys =
     if List.is_empty required_public_key_ids then return Int.Map.empty
     else
-      query_mainnet_db ~f:(fun (module Conn : CONNECTION) ->
+      query_mainnet_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
           Conn.collect_list
             (Mina_caqti.collect_req Caqti_type.unit
                Caqti_type.(t2 int Sql.Mainnet.Public_key.typ)
@@ -343,15 +342,11 @@ let main ~mainnet_archive_uri ~migrated_archive_uri ~runtime_config_file
   let logger = Logger.create () in
   let mainnet_archive_uri = Uri.of_string mainnet_archive_uri in
   let migrated_archive_uri = Uri.of_string migrated_archive_uri in
-  let pool_config =
-    Caqti_pool_config.(
-      merge_left (default_from_env ()) (create ~max_size:128 ()))
-  in
   let mainnet_pool =
-    Caqti_async.connect_pool ~pool_config mainnet_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 mainnet_archive_uri
   in
   let migrated_pool =
-    Caqti_async.connect_pool ~pool_config migrated_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 migrated_archive_uri
   in
   match (mainnet_pool, migrated_pool) with
   | Error e, _ | _, Error e ->
@@ -417,7 +412,7 @@ let main ~mainnet_archive_uri ~migrated_archive_uri ~runtime_config_file
          startup in order to be able to resume gracefully in the event of an unfortunate crash. *)
       let%bind () =
         let%bind garbage_block_ids =
-          query_migrated_db ~f:(fun (module Conn : CONNECTION) ->
+          query_migrated_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
               Conn.collect_list
                 (Mina_caqti.collect_req Caqti_type.unit Caqti_type.int
                    (sprintf
@@ -433,7 +428,7 @@ let main ~mainnet_archive_uri ~migrated_archive_uri ~runtime_config_file
             @@ List.map garbage_block_ids ~f:Int.to_string
           in
           let%bind () =
-            query_migrated_db ~f:(fun (module Conn : CONNECTION) ->
+            query_migrated_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
                 Conn.exec
                   (Mina_caqti.exec_req Caqti_type.unit
                      (sprintf "DELETE FROM %s WHERE block_id IN (%s)"
@@ -441,7 +436,7 @@ let main ~mainnet_archive_uri ~migrated_archive_uri ~runtime_config_file
                         .table_name garbage_block_ids_sql ) )
                   () )
           in
-          query_migrated_db ~f:(fun (module Conn : CONNECTION) ->
+          query_migrated_db ~f:(fun (module Conn : Mina_caqti.CONNECTION) ->
               Conn.exec
                 (Mina_caqti.exec_req Caqti_type.unit
                    (sprintf "DELETE FROM %s WHERE block_id IN (%s)"
diff --git a/src/app/berkeley_migration/sql.ml b/src/app/berkeley_migration/sql.ml
index 0bdddcfdaa..4b677e43f3 100644
--- a/src/app/berkeley_migration/sql.ml
+++ b/src/app/berkeley_migration/sql.ml
@@ -1,7 +1,6 @@
 (* sql.ml -- for reading the mainnet and berkeley databases (no writing!) *)
 
 open Core
-open Caqti_async
 
 module Mainnet = struct
   module Public_key = struct
@@ -17,7 +16,7 @@ module Mainnet = struct
 
     let table_name = "public_keys"
 
-    let find_by_id (module Conn : CONNECTION) id =
+    let find_by_id (module Conn : Mina_caqti.CONNECTION) id =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int Caqti_type.string
            "SELECT value FROM public_keys WHERE id = ?" )
@@ -25,7 +24,7 @@ module Mainnet = struct
   end
 
   module Snarked_ledger_hash = struct
-    let find_by_id (module Conn : CONNECTION) id =
+    let find_by_id (module Conn : Mina_caqti.CONNECTION) id =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int Caqti_type.string
            "SELECT value FROM snarked_ledger_hashes WHERE id = ?" )
@@ -77,7 +76,7 @@ module Mainnet = struct
       let decode t = Ok (of_hlist (tuple_to_hlist spec t)) in
       Caqti_type.custom ~encode ~decode (to_rep spec)
 
-    let id_from_state_hash (module Conn : CONNECTION) state_hash =
+    let id_from_state_hash (module Conn : Mina_caqti.CONNECTION) state_hash =
       Conn.find
         (Mina_caqti.find_req Caqti_type.string Caqti_type.int
            {sql| SELECT id
@@ -86,7 +85,7 @@ module Mainnet = struct
          |sql} )
         state_hash
 
-    let load (module Conn : CONNECTION) ~(id : int) =
+    let load (module Conn : Mina_caqti.CONNECTION) ~(id : int) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int typ
            {sql| SELECT id, state_hash, parent_id, parent_hash, creator_id,
@@ -96,7 +95,7 @@ module Mainnet = struct
                  WHERE id = ?                                                                                                    |sql} )
         id
 
-    let canonical_blocks (module Conn : CONNECTION) =
+    let canonical_blocks (module Conn : Mina_caqti.CONNECTION) =
       Conn.collect_list
         (Mina_caqti.collect_req Caqti_type.unit Caqti_type.int
            {sql| SELECT id
@@ -104,7 +103,7 @@ module Mainnet = struct
                  WHERE chain_status = 'canonical'
          |sql} )
 
-    let full_canonical_blocks (module Conn : CONNECTION) =
+    let full_canonical_blocks (module Conn : Mina_caqti.CONNECTION) =
       Conn.collect_list
         (Mina_caqti.collect_req Caqti_type.unit typ
            {sql| SELECT id, state_hash, parent_id, parent_hash, creator_id,
@@ -116,19 +115,19 @@ module Mainnet = struct
                  ORDER BY height ASC
          |sql} )
 
-    let mark_as_canonical (module Conn : CONNECTION) id =
+    let mark_as_canonical (module Conn : Mina_caqti.CONNECTION) id =
       Conn.exec
         (Mina_caqti.exec_req Caqti_type.int
            "UPDATE blocks SET chain_status='canonical' WHERE id = ?" )
         id
 
-    let get_highest_canonical_block (module Conn : CONNECTION) =
+    let get_highest_canonical_block (module Conn : Mina_caqti.CONNECTION) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.unit Caqti_type.int
            "SELECT id FROM blocks WHERE chain_status='canonical' ORDER BY \
             height DESC LIMIT 1" )
 
-    let get_subchain (module Conn : CONNECTION) ~start_block_id ~end_block_id =
+    let get_subchain (module Conn : Mina_caqti.CONNECTION) ~start_block_id ~end_block_id =
       (* derive query from type `t` *)
       Conn.collect_list
         (Mina_caqti.collect_req
@@ -194,7 +193,7 @@ module Mainnet = struct
       let decode t = Ok (of_hlist (tuple_to_hlist spec t)) in
       Caqti_type.custom ~encode ~decode (to_rep spec)
 
-    let load_block (module Conn : CONNECTION) ~block_id =
+    let load_block (module Conn : Mina_caqti.CONNECTION) ~block_id =
       Conn.collect_list
         (Mina_caqti.collect_req Caqti_type.int typ
            {sql| SELECT block_id, user_command_id,
@@ -233,7 +232,7 @@ module Mainnet = struct
       let decode t = Ok (of_hlist (tuple_to_hlist spec t)) in
       Caqti_type.custom ~encode ~decode (to_rep spec)
 
-    let load_block (module Conn : CONNECTION) ~block_id =
+    let load_block (module Conn : Mina_caqti.CONNECTION) ~block_id =
       Conn.collect_list
         (Mina_caqti.collect_req Caqti_type.int typ
            {sql| SELECT block_id, internal_command_id,
@@ -269,7 +268,7 @@ module Mainnet = struct
       let rep = Caqti_type.(t2 (t4 string int int64 int64) string) in
       Caqti_type.custom ~encode ~decode rep
 
-    let load (module Conn : CONNECTION) ~(id : int) =
+    let load (module Conn : Mina_caqti.CONNECTION) ~(id : int) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int typ
            {sql| SELECT type,receiver_id,fee,token,hash
@@ -336,7 +335,7 @@ module Mainnet = struct
       let decode t = Ok (of_hlist (tuple_to_hlist spec t)) in
       Caqti_type.custom ~encode ~decode (to_rep spec)
 
-    let load (module Conn : CONNECTION) ~(id : int) =
+    let load (module Conn : Mina_caqti.CONNECTION) ~(id : int) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int typ
            {sql| SELECT type,fee_payer_id,source_id,receiver_id,
@@ -350,14 +349,14 @@ end
 
 module Berkeley = struct
   module Block = struct
-    let count (module Conn : CONNECTION) =
+    let count (module Conn : Mina_caqti.CONNECTION) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.unit Caqti_type.int
            {sql| SELECT count (*)
                  FROM blocks
            |sql} )
 
-    let greatest_block_height (module Conn : CONNECTION) =
+    let greatest_block_height (module Conn : Mina_caqti.CONNECTION) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.unit Caqti_type.int64
            {sql| SELECT height
@@ -367,7 +366,7 @@ module Berkeley = struct
                  LIMIT 1
            |sql} )
 
-    let genesis_block_id (module Conn : CONNECTION) =
+    let genesis_block_id (module Conn : Mina_caqti.CONNECTION) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.unit Caqti_type.int
            {sql| SELECT id
@@ -386,7 +385,7 @@ module Berkeley = struct
       let decode t = Ok (of_hlist (tuple_to_hlist spec t)) in
       Caqti_type.custom ~encode ~decode (to_rep spec)
 
-    let load (module Conn : CONNECTION) =
+    let load (module Conn : Mina_caqti.CONNECTION) =
       Conn.find
         (Mina_caqti.find_req Caqti_type.int typ
            {sql| SELECT pk.value, t.value
@@ -398,7 +397,7 @@ module Berkeley = struct
   end
 
   module Accounts_accessed = struct
-    let greatest_ledger_index (module Conn : CONNECTION) =
+    let greatest_ledger_index (module Conn : Mina_caqti.CONNECTION) =
       Conn.find_opt
         (Mina_caqti.find_opt_req Caqti_type.int Caqti_type.int
            {sql| SELECT ledger_index
diff --git a/src/app/berkeley_migration_verifier/berkeley_migration_verifier.ml b/src/app/berkeley_migration_verifier/berkeley_migration_verifier.ml
index d183565cbe..a97801e306 100644
--- a/src/app/berkeley_migration_verifier/berkeley_migration_verifier.ml
+++ b/src/app/berkeley_migration_verifier/berkeley_migration_verifier.ml
@@ -284,18 +284,10 @@ let pre_fork_validations ~mainnet_archive_uri ~migrated_archive_uri () =
   let mainnet_archive_uri = Uri.of_string mainnet_archive_uri in
   let migrated_archive_uri = Uri.of_string migrated_archive_uri in
   let mainnet_pool =
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      mainnet_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 mainnet_archive_uri
   in
   let migrated_pool =
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      migrated_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 migrated_archive_uri
   in
 
   match (mainnet_pool, migrated_pool) with
@@ -382,15 +374,11 @@ let post_fork_validations ~mainnet_archive_uri ~migrated_archive_uri
 
   let mainnet_archive_uri = Uri.of_string mainnet_archive_uri in
   let migrated_archive_uri = Uri.of_string migrated_archive_uri in
-  let pool_config =
-    Caqti_pool_config.(
-      merge_left (default_from_env ()) (create ~max_size:128 ()))
-  in
   let mainnet_pool =
-    Caqti_async.connect_pool ~pool_config mainnet_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 mainnet_archive_uri
   in
   let migrated_pool =
-    Caqti_async.connect_pool ~pool_config migrated_archive_uri
+    Mina_caqti.connect_pool ~max_size:128 migrated_archive_uri
   in
 
   match (mainnet_pool, migrated_pool) with
diff --git a/src/app/berkeley_migration_verifier/sql.ml b/src/app/berkeley_migration_verifier/sql.ml
index 36b4e32401..c0e89348d2 100644
--- a/src/app/berkeley_migration_verifier/sql.ml
+++ b/src/app/berkeley_migration_verifier/sql.ml
@@ -1,5 +1,3 @@
-open Caqti_async
-
 let dump_sql_to_csv output_file ~sql =
   Printf.sprintf "COPY ( %s ) TO '%s' DELIMITER ',' CSV HEADER " sql output_file
 
@@ -28,7 +26,7 @@ module Mainnet = struct
       ORDER BY height, public_key |sql}
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_accounts_created_to_csv (module Conn : CONNECTION) output_file =
+  let dump_accounts_created_to_csv (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_accounts_created_to_csv_query ~output_file) ()
 
   let dump_state_and_ledger_hashes_to_csv_query ~output_file =
@@ -51,8 +49,8 @@ module Mainnet = struct
            \      " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_block_hashes_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_block_hashes_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_block_hashes_till_height_query ~output_file ~height) ()
 
   let dump_block_hashes_query ~output_file =
@@ -65,7 +63,7 @@ module Mainnet = struct
         \      "
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_block_hashes (module Conn : CONNECTION) output_file =
+  let dump_block_hashes (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_block_hashes_query ~output_file) ()
 
   let dump_user_commands_till_height_query ~output_file ~height =
@@ -89,8 +87,8 @@ module Mainnet = struct
            \      " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_user_commands_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_user_commands_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_user_commands_till_height_query ~output_file ~height) ()
 
   let dump_internal_commands_till_height_query ~output_file ~height =
@@ -114,8 +112,8 @@ module Mainnet = struct
            \          " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_internal_commands_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_internal_commands_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_internal_commands_till_height_query ~output_file ~height) ()
 
   let dump_user_commands_query ~output_file =
@@ -137,7 +135,7 @@ module Mainnet = struct
         \      "
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_user_commands (module Conn : CONNECTION) output_file =
+  let dump_user_commands (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_user_commands_query ~output_file) ()
 
   let dump_internal_commands_query ~output_file =
@@ -160,7 +158,7 @@ module Mainnet = struct
            \          " )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_internal_commands (module Conn : CONNECTION) output_file =
+  let dump_internal_commands (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_internal_commands_query ~output_file) ()
 
   let mark_chain_till_fork_block_as_canonical_query =
@@ -186,8 +184,8 @@ module Mainnet = struct
       )
       |sql}
 
-  let mark_chain_till_fork_block_as_canonical (module Conn : CONNECTION)
-      fork_state_hash =
+  let mark_chain_till_fork_block_as_canonical
+      (module Conn : Mina_caqti.CONNECTION) fork_state_hash =
     Conn.exec mark_chain_till_fork_block_as_canonical_query fork_state_hash
 end
 
@@ -204,7 +202,7 @@ module Berkeley = struct
       ORDER BY height, public_key |sql}
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_accounts_created_to_csv (module Conn : CONNECTION) output_file =
+  let dump_accounts_created_to_csv (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_accounts_created_to_csv_query ~output_file) ()
 
   let height_query =
@@ -213,7 +211,8 @@ module Berkeley = struct
             SELECT height from blocks order by height desc limit 1;
           |sql}
 
-  let block_height (module Conn : CONNECTION) = Conn.find height_query ()
+  let block_height (module Conn : Mina_caqti.CONNECTION) =
+    Conn.find height_query ()
 
   let canonical_blocks_count_till_height_query =
     Mina_caqti.find_req Caqti_type.int Caqti_type.int
@@ -230,7 +229,8 @@ module Berkeley = struct
         ) SELECT count(*) FROM chain where chain_status = 'canonical';
       |sql}
 
-  let canonical_blocks_count_till_height (module Conn : CONNECTION) height =
+  let canonical_blocks_count_till_height (module Conn : Mina_caqti.CONNECTION)
+      height =
     Conn.find canonical_blocks_count_till_height_query height
 
   let blocks_count_query =
@@ -239,7 +239,8 @@ module Berkeley = struct
           SELECT count(*) FROM blocks ;
         |sql}
 
-  let blocks_count (module Conn : CONNECTION) = Conn.find blocks_count_query ()
+  let blocks_count (module Conn : Mina_caqti.CONNECTION) =
+    Conn.find blocks_count_query ()
 
   let dump_user_commands_till_height_query ~output_file ~height =
     dump_sql_to_csv output_file
@@ -262,8 +263,8 @@ module Berkeley = struct
            \     " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_user_commands_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_user_commands_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_user_commands_till_height_query ~output_file ~height) ()
 
   let dump_internal_commands_till_height_query ~output_file ~height =
@@ -287,8 +288,8 @@ module Berkeley = struct
            \      " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_internal_commands_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_internal_commands_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_internal_commands_till_height_query ~output_file ~height) ()
 
   let dump_user_commands_query ~output_file =
@@ -310,7 +311,7 @@ module Berkeley = struct
         \     "
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_user_commands (module Conn : CONNECTION) output_file =
+  let dump_user_commands (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_user_commands_query ~output_file) ()
 
   let dump_internal_commands_query ~output_file =
@@ -332,7 +333,7 @@ module Berkeley = struct
         \      "
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_internal_commands (module Conn : CONNECTION) output_file =
+  let dump_internal_commands (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_internal_commands_query ~output_file) ()
 
   let dump_account_accessed_to_csv_query ~output_file =
@@ -345,7 +346,8 @@ module Berkeley = struct
                  ORDER BY block_id, id |sql}
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_accounts_accessed_to_csv (module Conn : CONNECTION) output_file =
+  let dump_accounts_accessed_to_csv (module Conn : Mina_caqti.CONNECTION)
+      output_file =
     Conn.exec (dump_account_accessed_to_csv_query ~output_file) ()
 
   let dump_block_hashes_till_height_query ~output_file ~height =
@@ -359,8 +361,8 @@ module Berkeley = struct
            \     " height )
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_block_hashes_till_height (module Conn : CONNECTION) output_file
-      height =
+  let dump_block_hashes_till_height (module Conn : Mina_caqti.CONNECTION)
+      output_file height =
     Conn.exec (dump_block_hashes_till_height_query ~output_file ~height) ()
 
   let dump_block_hashes_query ~output_file =
@@ -373,7 +375,7 @@ module Berkeley = struct
         \      "
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_block_hashes (module Conn : CONNECTION) output_file =
+  let dump_block_hashes (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_block_hashes_query ~output_file) ()
 
   let dump_user_and_internal_command_info_to_csv_query ~output_file =
@@ -405,15 +407,15 @@ module Berkeley = struct
       ) ORDER BY block_id, id |sql}
     |> Mina_caqti.exec_req Caqti_type.unit
 
-  let dump_user_and_internal_command_info_to_csv (module Conn : CONNECTION)
-      output_file =
+  let dump_user_and_internal_command_info_to_csv
+      (module Conn : Mina_caqti.CONNECTION) output_file =
     Conn.exec (dump_user_and_internal_command_info_to_csv_query ~output_file) ()
 
   let get_account_accessed_count_query =
     Mina_caqti.find_req Caqti_type.unit Caqti_type.int
       {sql| SELECT count(*) FROM accounts_accessed; |sql}
 
-  let count_account_accessed (module Conn : CONNECTION) =
+  let count_account_accessed (module Conn : Mina_caqti.CONNECTION) =
     Conn.find get_account_accessed_count_query ()
 
   let get_account_id_accessed_in_commands_query =
@@ -439,6 +441,7 @@ module Berkeley = struct
      
       |sql}
 
-  let get_account_id_accessed_in_commands (module Conn : CONNECTION) =
+  let get_account_id_accessed_in_commands (module Conn : Mina_caqti.CONNECTION)
+      =
     Conn.find get_account_id_accessed_in_commands_query ()
 end
diff --git a/src/app/delegation_compliance/delegation_compliance.ml b/src/app/delegation_compliance/delegation_compliance.ml
index 0216fbd1e3..d91071a33c 100644
--- a/src/app/delegation_compliance/delegation_compliance.ml
+++ b/src/app/delegation_compliance/delegation_compliance.ml
@@ -113,7 +113,7 @@ let global_slot_hashes_tbl : (Int64.t, State_hash.t * Ledger_hash.t) Hashtbl.t =
 let pk_tbl : (int, Account.key) Hashtbl.t = Int.Table.create ()
 
 let query_db pool ~f ~item =
-  match%bind Caqti_async.Pool.use f pool with
+  match%bind Mina_caqti.Pool.use f pool with
   | Ok v ->
       return v
   | Error msg ->
@@ -141,7 +141,7 @@ let pk_of_pk_id pool pk_id : Account.key Deferred.t =
   | None -> (
       (* not in cache, consult database *)
       match%map
-        Caqti_async.Pool.use (fun db -> Sql.Public_key.run db pk_id) pool
+        Mina_caqti.Pool.use (fun db -> Sql.Public_key.run db pk_id) pool
       with
       | Ok (Some pk) -> (
           match Signature_lib.Public_key.Compressed.of_base58_check pk with
@@ -162,7 +162,7 @@ let pk_of_pk_id pool pk_id : Account.key Deferred.t =
 let pk_id_of_pk pool pk : int Deferred.t =
   let open Deferred.Let_syntax in
   match%map
-    Caqti_async.Pool.use (fun db -> Sql.Public_key.run_for_id db pk) pool
+    Mina_caqti.Pool.use (fun db -> Sql.Public_key.run_for_id db pk) pool
   with
   | Ok (Some id) ->
       id
@@ -343,13 +343,7 @@ let main ~input_file ~csv_file ~preliminary_csv_file_opt ~archive_uri
         csv_datas
   in
   let archive_uri = Uri.of_string archive_uri in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
@@ -609,7 +603,7 @@ let main ~input_file ~csv_file ~preliminary_csv_file_opt ~archive_uri
                 ] ;
             let%bind coinbase_receiver_ids =
               match%map
-                Caqti_async.Pool.use
+                Mina_caqti.Pool.use
                   (fun db ->
                     Sql.Coinbase_receivers_for_block_creator.run db
                       ~block_creator_id:delegatee_id )
diff --git a/src/app/delegation_compliance/sql.ml b/src/app/delegation_compliance/sql.ml
index ea264fdeb6..713ea23916 100644
--- a/src/app/delegation_compliance/sql.ml
+++ b/src/app/delegation_compliance/sql.ml
@@ -34,7 +34,7 @@ module Block_info = struct
 
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) state_hash =
+  let run (module Conn : Mina_caqti.CONNECTION) state_hash =
     Conn.collect_list query state_hash
 end
 
@@ -144,7 +144,7 @@ module User_command = struct
 
        |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) user_cmd_id =
+  let run (module Conn : Mina_caqti.CONNECTION) user_cmd_id =
     Conn.collect_list query user_cmd_id
 
   let query_payments_by_source_and_receiver =
@@ -176,7 +176,7 @@ module User_command = struct
 
        |sql}
 
-  let run_payments_by_source_and_receiver (module Conn : Caqti_async.CONNECTION)
+  let run_payments_by_source_and_receiver (module Conn : Mina_caqti.CONNECTION)
       ~source_id ~receiver_id =
     Conn.collect_list query_payments_by_source_and_receiver
       (source_id, receiver_id)
@@ -207,7 +207,7 @@ module User_command = struct
 
        |sql}
 
-  let run_payments_by_receiver (module Conn : Caqti_async.CONNECTION)
+  let run_payments_by_receiver (module Conn : Mina_caqti.CONNECTION)
       ~receiver_id =
     Conn.collect_list query_payments_by_receiver receiver_id
 end
@@ -219,7 +219,7 @@ module Public_key = struct
             WHERE id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) pk_id =
+  let run (module Conn : Mina_caqti.CONNECTION) pk_id =
     Conn.find_opt query pk_id
 
   let query_for_id =
@@ -228,7 +228,7 @@ module Public_key = struct
             WHERE value = ?
       |sql}
 
-  let run_for_id (module Conn : Caqti_async.CONNECTION) pk =
+  let run_for_id (module Conn : Mina_caqti.CONNECTION) pk =
     Conn.find_opt query_for_id pk
 end
 
@@ -238,7 +238,7 @@ module Block = struct
       {sql| SELECT MAX(global_slot) FROM blocks
       |sql}
 
-  let get_max_slot (module Conn : Caqti_async.CONNECTION) () =
+  let get_max_slot (module Conn : Mina_caqti.CONNECTION) () =
     Conn.find max_slot_query ()
 
   let state_hashes_by_slot_query =
@@ -246,7 +246,7 @@ module Block = struct
       {sql| SELECT state_hash FROM blocks WHERE global_slot = $1
       |sql}
 
-  let get_state_hashes_by_slot (module Conn : Caqti_async.CONNECTION) slot =
+  let get_state_hashes_by_slot (module Conn : Mina_caqti.CONNECTION) slot =
     Conn.collect_list state_hashes_by_slot_query slot
 
   let creator_slot_bounds_query =
@@ -259,7 +259,7 @@ module Block = struct
       |sql}
 
   let get_block_ids_for_creator_in_slot_bounds
-      (module Conn : Caqti_async.CONNECTION) ~creator ~low_slot ~high_slot =
+      (module Conn : Mina_caqti.CONNECTION) ~creator ~low_slot ~high_slot =
     Conn.collect_list creator_slot_bounds_query (creator, low_slot, high_slot)
 end
 
@@ -290,6 +290,6 @@ module Coinbase_receivers_for_block_creator = struct
               AND ic.receiver_id <> b.creator_id
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_creator_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_creator_id =
     Conn.collect_list query block_creator_id
 end
diff --git a/src/app/extract_blocks/extract_blocks.ml b/src/app/extract_blocks/extract_blocks.ml
index 1bf72965c9..a104ffaa68 100644
--- a/src/app/extract_blocks/extract_blocks.ml
+++ b/src/app/extract_blocks/extract_blocks.ml
@@ -479,13 +479,7 @@ let main ~archive_uri ~start_state_hash_opt ~end_state_hash_opt ~all_blocks () =
   (* sanity-check input state hashes *)
   check_state_hash ~logger start_state_hash_opt ;
   check_state_hash ~logger end_state_hash_opt ;
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/app/extract_blocks/sql.ml b/src/app/extract_blocks/sql.ml
index 0f614da7c7..5233a16a89 100644
--- a/src/app/extract_blocks/sql.ml
+++ b/src/app/extract_blocks/sql.ml
@@ -43,11 +43,11 @@ module Subchain = struct
            "b.id = chain.parent_id AND (chain.state_hash <> $2 OR b.state_hash \
             = $2)" )
 
-  let start_from_unparented (module Conn : Caqti_async.CONNECTION)
+  let start_from_unparented (module Conn : Mina_caqti.CONNECTION)
       ~end_state_hash =
     Conn.collect_list query_unparented end_state_hash
 
-  let start_from_specified (module Conn : Caqti_async.CONNECTION)
+  let start_from_specified (module Conn : Mina_caqti.CONNECTION)
       ~start_state_hash ~end_state_hash =
     Conn.collect_list query_from_start (end_state_hash, start_state_hash)
 
@@ -59,7 +59,7 @@ module Subchain = struct
     Mina_caqti.collect_req Caqti_type.unit Archive_lib.Processor.Block.typ
       (sprintf "SELECT %s FROM blocks" comma_fields)
 
-  let all_blocks (module Conn : Caqti_async.CONNECTION) =
+  let all_blocks (module Conn : Mina_caqti.CONNECTION) =
     Conn.collect_list query_all ()
 end
 
@@ -74,7 +74,7 @@ module Blocks_and_user_commands = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
 
@@ -105,7 +105,7 @@ module Block_user_command_tokens = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
 
@@ -130,7 +130,7 @@ module Blocks_and_internal_commands = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
 
@@ -161,7 +161,7 @@ module Block_internal_command_tokens = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
 
@@ -174,7 +174,7 @@ module Blocks_and_zkapp_commands = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
 
@@ -208,6 +208,6 @@ module Block_zkapp_command_tokens = struct
             WHERE block_id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.collect_list query block_id
 end
diff --git a/src/app/migrate-balances-table/migrate_balances_table.ml b/src/app/migrate-balances-table/migrate_balances_table.ml
index ea8f83f841..ea2efbce41 100644
--- a/src/app/migrate-balances-table/migrate_balances_table.ml
+++ b/src/app/migrate-balances-table/migrate_balances_table.ml
@@ -4,7 +4,7 @@ open Core_kernel
 open Async
 
 let query_db pool ~f ~item =
-  match%bind Caqti_async.Pool.use f pool with
+  match%bind Mina_caqti.Pool.use f pool with
   | Ok v ->
       return v
   | Error msg ->
@@ -14,13 +14,7 @@ let query_db pool ~f ~item =
 let main ~archive_uri () =
   let logger = Logger.create () in
   let archive_uri = Uri.of_string archive_uri in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/app/migrate-balances-table/sql.ml b/src/app/migrate-balances-table/sql.ml
index f0bc5f8c81..be4d000a4d 100644
--- a/src/app/migrate-balances-table/sql.ml
+++ b/src/app/migrate-balances-table/sql.ml
@@ -2,7 +2,7 @@
 
 open Core_kernel
 
-let create_temp_balances_table (module Conn : Caqti_async.CONNECTION) =
+let create_temp_balances_table (module Conn : Mina_caqti.CONNECTION) =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        {sql| CREATE TABLE IF NOT EXISTS balances_temp
@@ -17,7 +17,7 @@ let create_temp_balances_table (module Conn : Caqti_async.CONNECTION) =
            )
       |sql} )
 
-let copy_table_to_temp_table (module Conn : Caqti_async.CONNECTION) table =
+let copy_table_to_temp_table (module Conn : Mina_caqti.CONNECTION) table =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf
@@ -25,7 +25,7 @@ let copy_table_to_temp_table (module Conn : Caqti_async.CONNECTION) table =
                 |sql}
           table table ) )
 
-let create_table_index (module Conn : Caqti_async.CONNECTION) table col =
+let create_table_index (module Conn : Mina_caqti.CONNECTION) table col =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf
@@ -33,10 +33,10 @@ let create_table_index (module Conn : Caqti_async.CONNECTION) table col =
                 |sql}
           table col table col ) )
 
-let create_temp_table_index (module Conn : Caqti_async.CONNECTION) table col =
+let create_temp_table_index (module Conn : Mina_caqti.CONNECTION) table col =
   create_table_index (module Conn) (sprintf "%s_temp" table) col
 
-let create_table_named_index (module Conn : Caqti_async.CONNECTION) table col
+let create_table_named_index (module Conn : Mina_caqti.CONNECTION) table col
     name =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
@@ -45,20 +45,20 @@ let create_table_named_index (module Conn : Caqti_async.CONNECTION) table col
                 |sql}
           table name table col ) )
 
-let create_temp_table_named_index (module Conn : Caqti_async.CONNECTION) table
+let create_temp_table_named_index (module Conn : Mina_caqti.CONNECTION) table
     col name =
   create_table_named_index (module Conn) (sprintf "%s_temp" table) col name
 
-let drop_table_index (module Conn : Caqti_async.CONNECTION) table col =
+let drop_table_index (module Conn : Mina_caqti.CONNECTION) table col =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf {sql| DROP INDEX IF EXISTS idx_%s_%s
           |sql} table col ) )
 
-let drop_temp_table_index (module Conn : Caqti_async.CONNECTION) table col =
+let drop_temp_table_index (module Conn : Mina_caqti.CONNECTION) table col =
   drop_table_index (module Conn) (sprintf "%s_temp" table) col
 
-let create_cursor (module Conn : Caqti_async.CONNECTION) name =
+let create_cursor (module Conn : Mina_caqti.CONNECTION) name =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf
@@ -67,7 +67,7 @@ let create_cursor (module Conn : Caqti_async.CONNECTION) name =
                  |sql}
           name ) )
 
-let initialize_cursor (module Conn : Caqti_async.CONNECTION) name =
+let initialize_cursor (module Conn : Mina_caqti.CONNECTION) name =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf
@@ -75,13 +75,13 @@ let initialize_cursor (module Conn : Caqti_async.CONNECTION) name =
                 |sql}
           name ) )
 
-let current_cursor (module Conn : Caqti_async.CONNECTION) name =
+let current_cursor (module Conn : Mina_caqti.CONNECTION) name =
   Conn.find_opt
     (Mina_caqti.find_opt_req Caqti_type.unit Caqti_type.int
        (sprintf {sql| SELECT value FROM %s_cursor
                 |sql} name ) )
 
-let update_cursor (module Conn : Caqti_async.CONNECTION) name ndx =
+let update_cursor (module Conn : Mina_caqti.CONNECTION) name ndx =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.int
        (sprintf
@@ -90,7 +90,7 @@ let update_cursor (module Conn : Caqti_async.CONNECTION) name ndx =
           name ) )
     ndx
 
-let drop_foreign_key_constraint (module Conn : Caqti_async.CONNECTION) table
+let drop_foreign_key_constraint (module Conn : Mina_caqti.CONNECTION) table
     foreign_key =
   let sql =
     sprintf
@@ -101,7 +101,7 @@ let drop_foreign_key_constraint (module Conn : Caqti_async.CONNECTION) table
   in
   Conn.exec (Mina_caqti.exec_req Caqti_type.unit sql)
 
-let add_balances_foreign_key_constraint (module Conn : Caqti_async.CONNECTION)
+let add_balances_foreign_key_constraint (module Conn : Mina_caqti.CONNECTION)
     table col foreign_key =
   let sql =
     sprintf
@@ -114,7 +114,7 @@ let add_balances_foreign_key_constraint (module Conn : Caqti_async.CONNECTION)
   in
   Conn.exec (Mina_caqti.exec_req Caqti_type.unit sql)
 
-let add_blocks_foreign_key_constraint (module Conn : Caqti_async.CONNECTION)
+let add_blocks_foreign_key_constraint (module Conn : Mina_caqti.CONNECTION)
     table col foreign_key =
   let sql =
     sprintf
@@ -127,7 +127,7 @@ let add_blocks_foreign_key_constraint (module Conn : Caqti_async.CONNECTION)
   in
   Conn.exec (Mina_caqti.exec_req Caqti_type.unit sql)
 
-let find_balance_entry (module Conn : Caqti_async.CONNECTION) ~public_key_id
+let find_balance_entry (module Conn : Mina_caqti.CONNECTION) ~public_key_id
     ~balance ~block_id ~block_height ~block_sequence_no
     ~block_secondary_sequence_no =
   Conn.find_opt
@@ -148,7 +148,7 @@ let find_balance_entry (module Conn : Caqti_async.CONNECTION) ~public_key_id
     , (block_id, block_height, block_sequence_no, block_secondary_sequence_no)
     )
 
-let insert_balance_entry (module Conn : Caqti_async.CONNECTION) ~public_key_id
+let insert_balance_entry (module Conn : Mina_caqti.CONNECTION) ~public_key_id
     ~balance ~block_id ~block_height ~block_sequence_no
     ~block_secondary_sequence_no =
   Conn.find
@@ -176,7 +176,7 @@ let insert_balance_entry (module Conn : Caqti_async.CONNECTION) ~public_key_id
     , (block_id, block_height, block_sequence_no, block_secondary_sequence_no)
     )
 
-let get_internal_commands (module Conn : Caqti_async.CONNECTION) =
+let get_internal_commands (module Conn : Mina_caqti.CONNECTION) =
   Conn.collect_list
     (Mina_caqti.collect_req Caqti_type.unit
        Caqti_type.(t4 int int64 (t4 int int int int) int)
@@ -190,7 +190,7 @@ let get_internal_commands (module Conn : Caqti_async.CONNECTION) =
       |sql} )
 
 let update_internal_command_receiver_balance
-    (module Conn : Caqti_async.CONNECTION) ~new_balance_id ~block_id
+    (module Conn : Mina_caqti.CONNECTION) ~new_balance_id ~block_id
     ~internal_command_id ~block_sequence_no ~block_secondary_sequence_no =
   Conn.exec
     (Mina_caqti.exec_req
@@ -207,7 +207,7 @@ let update_internal_command_receiver_balance
       , block_sequence_no
       , block_secondary_sequence_no ) )
 
-let get_user_command_fee_payers (module Conn : Caqti_async.CONNECTION) =
+let get_user_command_fee_payers (module Conn : Mina_caqti.CONNECTION) =
   Conn.collect_list
     (Mina_caqti.collect_req Caqti_type.unit
        Caqti_type.(t2 (t4 int int int int) (t2 int int64))
@@ -220,7 +220,7 @@ let get_user_command_fee_payers (module Conn : Caqti_async.CONNECTION) =
                        bal_fee_payer.public_key_id,bal_fee_payer.balance)
       |sql} )
 
-let get_user_command_sources (module Conn : Caqti_async.CONNECTION) =
+let get_user_command_sources (module Conn : Mina_caqti.CONNECTION) =
   Conn.collect_list
     (Mina_caqti.collect_req Caqti_type.unit
        Caqti_type.(t2 (t4 int int int int) (t2 int int64))
@@ -234,7 +234,7 @@ let get_user_command_sources (module Conn : Caqti_async.CONNECTION) =
                        bal_source.public_key_id,bal_source.balance)
       |sql} )
 
-let get_user_command_receivers (module Conn : Caqti_async.CONNECTION) =
+let get_user_command_receivers (module Conn : Mina_caqti.CONNECTION) =
   Conn.collect_list
     (Mina_caqti.collect_req Caqti_type.unit
        Caqti_type.(t2 (t4 int int int int) (t2 int int64))
@@ -248,7 +248,7 @@ let get_user_command_receivers (module Conn : Caqti_async.CONNECTION) =
                        bal_receiver.public_key_id,bal_receiver.balance)
       |sql} )
 
-let update_user_command_fee_payer_balance (module Conn : Caqti_async.CONNECTION)
+let update_user_command_fee_payer_balance (module Conn : Mina_caqti.CONNECTION)
     ~new_balance_id ~block_id ~user_command_id ~block_sequence_no =
   Conn.exec
     (Mina_caqti.exec_req
@@ -260,7 +260,7 @@ let update_user_command_fee_payer_balance (module Conn : Caqti_async.CONNECTION)
       |sql} )
     (new_balance_id, (block_id, user_command_id, block_sequence_no))
 
-let update_user_command_source_balance (module Conn : Caqti_async.CONNECTION)
+let update_user_command_source_balance (module Conn : Mina_caqti.CONNECTION)
     ~new_balance_id ~block_id ~user_command_id ~block_sequence_no =
   Conn.exec
     (Mina_caqti.exec_req
@@ -273,7 +273,7 @@ let update_user_command_source_balance (module Conn : Caqti_async.CONNECTION)
       |sql} )
     (new_balance_id, (block_id, user_command_id, block_sequence_no))
 
-let update_user_command_receiver_balance (module Conn : Caqti_async.CONNECTION)
+let update_user_command_receiver_balance (module Conn : Mina_caqti.CONNECTION)
     ~new_balance_id ~block_id ~user_command_id ~block_sequence_no =
   Conn.exec
     (Mina_caqti.exec_req
@@ -286,13 +286,13 @@ let update_user_command_receiver_balance (module Conn : Caqti_async.CONNECTION)
       |sql} )
     (new_balance_id, (block_id, user_command_id, block_sequence_no))
 
-let drop_table (module Conn : Caqti_async.CONNECTION) table =
+let drop_table (module Conn : Mina_caqti.CONNECTION) table =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf {sql| DROP TABLE %s
                 |sql} table ) )
 
-let rename_temp_table (module Conn : Caqti_async.CONNECTION) table =
+let rename_temp_table (module Conn : Mina_caqti.CONNECTION) table =
   Conn.exec
     (Mina_caqti.exec_req Caqti_type.unit
        (sprintf
@@ -301,7 +301,7 @@ let rename_temp_table (module Conn : Caqti_async.CONNECTION) table =
           |sql}
           table table ) )
 
-let get_column_count (module Conn : Caqti_async.CONNECTION) table =
+let get_column_count (module Conn : Mina_caqti.CONNECTION) table =
   Conn.find
     (Mina_caqti.find_req Caqti_type.string Caqti_type.int
        {sql| SELECT COUNT(*) FROM information_schema.columns
diff --git a/src/app/missing_blocks_auditor/missing_blocks_auditor.ml b/src/app/missing_blocks_auditor/missing_blocks_auditor.ml
index d2b54f3615..7fbadcf59b 100644
--- a/src/app/missing_blocks_auditor/missing_blocks_auditor.ml
+++ b/src/app/missing_blocks_auditor/missing_blocks_auditor.ml
@@ -22,13 +22,7 @@ let add_error, get_exit_code =
 let main ~archive_uri () =
   let logger = Logger.create () in
   let archive_uri = Uri.of_string archive_uri in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
@@ -39,7 +33,7 @@ let main ~archive_uri () =
       [%log info] "Querying missing blocks" ;
       let%bind missing_blocks_raw =
         match%bind
-          Caqti_async.Pool.use (fun db -> Sql.Unparented_blocks.run db ()) pool
+          Mina_caqti.Pool.use (fun db -> Sql.Unparented_blocks.run db ()) pool
         with
         | Ok blocks ->
             return blocks
@@ -60,7 +54,7 @@ let main ~archive_uri () =
           Deferred.List.iter missing_blocks
             ~f:(fun (block_id, state_hash, height, parent_hash) ->
               match%map
-                Caqti_async.Pool.use
+                Mina_caqti.Pool.use
                   (fun db -> Sql.Missing_blocks_gap.run db height)
                   pool
               with
@@ -82,7 +76,7 @@ let main ~archive_uri () =
       [%log info] "Querying for gaps in chain statuses" ;
       let%bind highest_canonical =
         match%bind
-          Caqti_async.Pool.use
+          Mina_caqti.Pool.use
             (fun db -> Sql.Chain_status.run_highest_canonical db ())
             pool
         with
@@ -95,7 +89,7 @@ let main ~archive_uri () =
       in
       let%bind pending_below =
         match%bind
-          Caqti_async.Pool.use
+          Mina_caqti.Pool.use
             (fun db ->
               Sql.Chain_status.run_count_pending_below db highest_canonical )
             pool
@@ -124,7 +118,7 @@ let main ~archive_uri () =
             ] ) ;
       let%bind canonical_chain =
         match%bind
-          Caqti_async.Pool.use
+          Mina_caqti.Pool.use
             (fun db -> Sql.Chain_status.run_canonical_chain db highest_canonical)
             pool
         with
diff --git a/src/app/missing_blocks_auditor/sql.ml b/src/app/missing_blocks_auditor/sql.ml
index d8a47b926d..7aa4108f02 100644
--- a/src/app/missing_blocks_auditor/sql.ml
+++ b/src/app/missing_blocks_auditor/sql.ml
@@ -11,7 +11,7 @@ module Unparented_blocks = struct
            WHERE parent_id IS NULL
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) () = Conn.collect_list query ()
+  let run (module Conn : Mina_caqti.CONNECTION) () = Conn.collect_list query ()
 end
 
 module Missing_blocks_gap = struct
@@ -21,7 +21,7 @@ module Missing_blocks_gap = struct
             WHERE height < $1
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) height = Conn.find query height
+  let run (module Conn : Mina_caqti.CONNECTION) height = Conn.find query height
 end
 
 module Chain_status = struct
@@ -31,7 +31,7 @@ module Chain_status = struct
             WHERE chain_status = 'canonical'
       |sql}
 
-  let run_highest_canonical (module Conn : Caqti_async.CONNECTION) () =
+  let run_highest_canonical (module Conn : Mina_caqti.CONNECTION) () =
     Conn.find query_highest_canonical ()
 
   let query_count_pending_below =
@@ -41,7 +41,7 @@ module Chain_status = struct
             AND height <= ?
       |sql}
 
-  let run_count_pending_below (module Conn : Caqti_async.CONNECTION) height =
+  let run_count_pending_below (module Conn : Mina_caqti.CONNECTION) height =
     Conn.find query_count_pending_below height
 
   let query_canonical_chain =
@@ -69,6 +69,6 @@ module Chain_status = struct
               ORDER BY id ASC
       |sql}
 
-  let run_canonical_chain (module Conn : Caqti_async.CONNECTION) height =
+  let run_canonical_chain (module Conn : Mina_caqti.CONNECTION) height =
     Conn.collect_list query_canonical_chain height
 end
diff --git a/src/app/patch_archive_test/patch_archive_test.ml b/src/app/patch_archive_test/patch_archive_test.ml
index 017b6574fc..b01932ec95 100644
--- a/src/app/patch_archive_test/patch_archive_test.ml
+++ b/src/app/patch_archive_test/patch_archive_test.ml
@@ -21,7 +21,7 @@ let make_archive_copy_uri archive_uri =
   Uri.with_path archive_uri ("/copy_of_" ^ db)
 
 let query_db pool ~f ~item =
-  match%bind Caqti_async.Pool.use f pool with
+  match%bind Mina_caqti.Pool.use f pool with
   | Ok v ->
       return v
   | Error msg ->
@@ -124,13 +124,7 @@ let main ~archive_uri ~num_blocks_to_patch ~archive_blocks_path
   let copy_uri = make_archive_copy_uri archive_uri in
   [%log info] "Connecting to original database" ;
   let%bind () =
-    match
-      Caqti_async.connect_pool
-        ~pool_config:
-          Caqti_pool_config.(
-            merge_left (default_from_env ()) (create ~max_size:128 ()))
-        archive_uri
-    with
+    match Mina_caqti.connect_pool ~max_size:128 archive_uri with
     | Error e ->
         [%log fatal]
           ~metadata:[ ("error", `String (Caqti_error.show e)) ]
@@ -143,7 +137,7 @@ let main ~archive_uri ~num_blocks_to_patch ~archive_blocks_path
         [%log info] "Dropping copied database, in case it already exists" ;
         let%bind () =
           match%bind
-            Caqti_async.Pool.use
+            Mina_caqti.Pool.use
               (fun db -> Sql.Copy_database.run_drop_db db ~copy_db)
               pool
           with
@@ -165,13 +159,7 @@ let main ~archive_uri ~num_blocks_to_patch ~archive_blocks_path
         ()
   in
   [%log info] "Connecting to copied database" ;
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      copy_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 copy_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/app/replayer/replayer.ml b/src/app/replayer/replayer.ml
index fd1fe8137e..a9dfd1bf87 100644
--- a/src/app/replayer/replayer.ml
+++ b/src/app/replayer/replayer.ml
@@ -46,7 +46,7 @@ type output =
 
 module type Get_command_ids = sig
   val run :
-       Caqti_async.connection
+       (module Mina_caqti.CONNECTION)
     -> state_hash:string
     -> start_slot:int64
     -> (int list, [> Caqti_error.call_or_retrieve ]) Deferred.Result.t
@@ -173,7 +173,7 @@ let get_slot_hashes slot = Hashtbl.find global_slot_hashes_tbl slot
 
 let process_block_infos_of_state_hash ~logger pool ~state_hash ~start_slot ~f =
   match%bind
-    Caqti_async.Pool.use
+    Mina_caqti.Pool.use
       (fun db -> Sql.Block_info.run db ~state_hash ~start_slot)
       pool
   with
@@ -656,13 +656,7 @@ let main ~input_file ~output_file_opt ~migration_mode ~archive_uri
              msg )
   in
   let archive_uri = Uri.of_string archive_uri in
-  match
-    Caqti_async.connect_pool
-      ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:128 ()))
-      archive_uri
-  with
+  match Mina_caqti.connect_pool ~max_size:128 archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
@@ -800,7 +794,7 @@ let main ~input_file ~output_file_opt ~migration_mode ~archive_uri
       (* end mutable state *)
       let get_command_ids (module Command_ids : Get_command_ids) name =
         match%bind
-          Caqti_async.Pool.use
+          Mina_caqti.Pool.use
             (fun db ->
               Command_ids.run db ~state_hash:target_state_hash
                 ~start_slot:input.start_slot_since_genesis )
@@ -836,7 +830,7 @@ let main ~input_file ~output_file_opt ~migration_mode ~archive_uri
         Deferred.List.map internal_cmd_ids ~f:(fun id ->
             let open Deferred.Let_syntax in
             match%map
-              Caqti_async.Pool.use
+              Mina_caqti.Pool.use
                 (fun db ->
                   Sql.Internal_command.run db
                     ~start_slot:input.start_slot_since_genesis
@@ -902,7 +896,7 @@ let main ~input_file ~output_file_opt ~migration_mode ~archive_uri
             Deferred.List.map user_cmd_ids ~f:(fun id ->
                 let open Deferred.Let_syntax in
                 match%map
-                  Caqti_async.Pool.use
+                  Mina_caqti.Pool.use
                     (fun db -> Sql.User_command.run db id)
                     pool
                 with
@@ -943,7 +937,7 @@ let main ~input_file ~output_file_opt ~migration_mode ~archive_uri
             Deferred.List.map zkapp_cmd_ids ~f:(fun id ->
                 let open Deferred.Let_syntax in
                 match%map
-                  Caqti_async.Pool.use
+                  Mina_caqti.Pool.use
                     (fun db -> Sql.Zkapp_command.run db id)
                     pool
                 with
diff --git a/src/app/replayer/sql.ml b/src/app/replayer/sql.ml
index 54c32b7274..160e213187 100644
--- a/src/app/replayer/sql.ml
+++ b/src/app/replayer/sql.ml
@@ -34,7 +34,7 @@ module Block_info = struct
 
            SELECT id,global_slot_since_genesis,state_hash,ledger_hash, snarked_ledger_hash_id FROM chain c                                                                                                                                                                      WHERE c.global_slot_since_genesis >= $2                                                                                                                                                                                                 |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~state_hash ~start_slot =
+  let run (module Conn : Mina_caqti.CONNECTION) ~state_hash ~start_slot =
     Conn.collect_list query (state_hash, start_slot)
 end
 
@@ -76,7 +76,7 @@ module Block = struct
             WHERE id = ?
       |sql}
 
-  let get_state_hash (module Conn : Caqti_async.CONNECTION) id =
+  let get_state_hash (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find state_hash_query id
 
   let parent_id_query =
@@ -85,7 +85,7 @@ module Block = struct
             WHERE id = ?
       |sql}
 
-  let get_parent_id (module Conn : Caqti_async.CONNECTION) id =
+  let get_parent_id (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find parent_id_query id
 
   let unparented_query =
@@ -94,21 +94,21 @@ module Block = struct
             WHERE parent_id IS NULL
       |sql}
 
-  let get_unparented (module Conn : Caqti_async.CONNECTION) () =
+  let get_unparented (module Conn : Mina_caqti.CONNECTION) () =
     Conn.collect_list unparented_query ()
 
   let get_height_query =
     Mina_caqti.find_req Caqti_type.int Caqti_type.int64
       {sql| SELECT height FROM blocks WHERE id = $1 |sql}
 
-  let get_height (module Conn : Caqti_async.CONNECTION) ~block_id =
+  let get_height (module Conn : Mina_caqti.CONNECTION) ~block_id =
     Conn.find get_height_query block_id
 
   let max_slot_query =
     Mina_caqti.find_req Caqti_type.unit Caqti_type.int64
       {sql| SELECT MAX(global_slot_since_genesis) FROM blocks |sql}
 
-  let get_max_slot (module Conn : Caqti_async.CONNECTION) () =
+  let get_max_slot (module Conn : Mina_caqti.CONNECTION) () =
     Conn.find max_slot_query ()
 
   let max_canonical_slot_query =
@@ -117,7 +117,7 @@ module Block = struct
             WHERE chain_status = 'canonical'
       |sql}
 
-  let get_max_canonical_slot (module Conn : Caqti_async.CONNECTION) () =
+  let get_max_canonical_slot (module Conn : Mina_caqti.CONNECTION) () =
     Conn.find max_canonical_slot_query ()
 
   let next_slot_query =
@@ -129,14 +129,14 @@ module Block = struct
             LIMIT 1
       |sql}
 
-  let get_next_slot (module Conn : Caqti_async.CONNECTION) slot =
+  let get_next_slot (module Conn : Mina_caqti.CONNECTION) slot =
     Conn.find_opt next_slot_query slot
 
   let state_hashes_by_slot_query =
     Mina_caqti.collect_req Caqti_type.int64 Caqti_type.string
       {sql| SELECT state_hash FROM blocks WHERE global_slot_since_genesis = $1 |sql}
 
-  let get_state_hashes_by_slot (module Conn : Caqti_async.CONNECTION) slot =
+  let get_state_hashes_by_slot (module Conn : Mina_caqti.CONNECTION) slot =
     Conn.collect_list state_hashes_by_slot_query slot
 
   (* find all blocks, working back from block with given state hash *)
@@ -159,7 +159,7 @@ module Block = struct
 
       |sql}
 
-  let get_chain (module Conn : Caqti_async.CONNECTION) state_hash =
+  let get_chain (module Conn : Mina_caqti.CONNECTION) state_hash =
     Conn.collect_list chain_query state_hash
 
   (* either the bonafide genesis block, or the most recent "linking" block
@@ -186,7 +186,7 @@ module Block = struct
          |sql}
          genesis_winner )
 
-  let genesis_snarked_ledger (module Conn : Caqti_async.CONNECTION) start_slot =
+  let genesis_snarked_ledger (module Conn : Mina_caqti.CONNECTION) start_slot =
     Conn.find genesis_snarked_ledger_query start_slot
 end
 
@@ -197,7 +197,7 @@ module User_command_ids = struct
       Caqti_type.int
       (find_command_ids_query "user")
 
-  let run (module Conn : Caqti_async.CONNECTION) ~state_hash ~start_slot =
+  let run (module Conn : Mina_caqti.CONNECTION) ~state_hash ~start_slot =
     Conn.collect_list query (state_hash, start_slot)
 end
 
@@ -259,7 +259,7 @@ module User_command = struct
 
        |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) user_cmd_id =
+  let run (module Conn : Mina_caqti.CONNECTION) user_cmd_id =
     Conn.collect_list query user_cmd_id
 end
 
@@ -270,7 +270,7 @@ module Zkapp_command_ids = struct
       Caqti_type.int
       (find_command_ids_query "zkapp")
 
-  let run (module Conn : Caqti_async.CONNECTION) ~state_hash ~start_slot =
+  let run (module Conn : Mina_caqti.CONNECTION) ~state_hash ~start_slot =
     Conn.collect_list query (state_hash, start_slot)
 end
 
@@ -311,7 +311,7 @@ module Zkapp_command = struct
 
        |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) zkapp_cmd_id =
+  let run (module Conn : Mina_caqti.CONNECTION) zkapp_cmd_id =
     Conn.collect_list query zkapp_cmd_id
 end
 
@@ -322,7 +322,7 @@ module Internal_command_ids = struct
       Caqti_type.int
       (find_command_ids_query "internal")
 
-  let run (module Conn : Caqti_async.CONNECTION) ~state_hash ~start_slot =
+  let run (module Conn : Mina_caqti.CONNECTION) ~state_hash ~start_slot =
     Conn.collect_list query (state_hash, start_slot)
 end
 
@@ -371,7 +371,7 @@ module Internal_command = struct
             WHERE b.global_slot_since_genesis >= $1
        |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) ~start_slot ~internal_cmd_id =
+  let run (module Conn : Mina_caqti.CONNECTION) ~start_slot ~internal_cmd_id =
     Conn.collect_list query (start_slot, internal_cmd_id)
 end
 
@@ -382,7 +382,7 @@ module Public_key = struct
             WHERE id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) pk_id =
+  let run (module Conn : Mina_caqti.CONNECTION) pk_id =
     Conn.find_opt query pk_id
 end
 
@@ -393,7 +393,7 @@ module Snarked_ledger_hashes = struct
             WHERE id = ?
       |sql}
 
-  let run (module Conn : Caqti_async.CONNECTION) id = Conn.find query id
+  let run (module Conn : Mina_caqti.CONNECTION) id = Conn.find query id
 end
 
 module Epoch_data = struct
@@ -421,7 +421,7 @@ module Epoch_data = struct
 
       |sql}
 
-  let get_epoch_data (module Conn : Caqti_async.CONNECTION) epoch_ledger_id =
+  let get_epoch_data (module Conn : Mina_caqti.CONNECTION) epoch_ledger_id =
     Conn.find query_epoch_data epoch_ledger_id
 
   let query_staking_epoch_data_id =
@@ -432,8 +432,8 @@ module Epoch_data = struct
 
       |sql}
 
-  let get_staking_epoch_data_id (module Conn : Caqti_async.CONNECTION)
-      state_hash =
+  let get_staking_epoch_data_id (module Conn : Mina_caqti.CONNECTION) state_hash
+      =
     Conn.find query_staking_epoch_data_id state_hash
 
   let query_next_epoch_data_id =
@@ -443,7 +443,7 @@ module Epoch_data = struct
             WHERE state_hash = ?
       |sql}
 
-  let get_next_epoch_data_id (module Conn : Caqti_async.CONNECTION) state_hash =
+  let get_next_epoch_data_id (module Conn : Mina_caqti.CONNECTION) state_hash =
     Conn.find query_next_epoch_data_id state_hash
 end
 
@@ -460,7 +460,7 @@ module Parent_block = struct
             ON epoch_ledgers_block.parent_id = parent.id
       |sql}
 
-  let get_parent_state_hash (module Conn : Caqti_async.CONNECTION)
+  let get_parent_state_hash (module Conn : Mina_caqti.CONNECTION)
       epoch_ledgers_state_hash =
     Conn.find query_parent_state_hash epoch_ledgers_state_hash
 end
diff --git a/src/app/rosetta/lib/account.ml b/src/app/rosetta/lib/account.ml
index 18b94265ed..81599bbef6 100644
--- a/src/app/rosetta/lib/account.ml
+++ b/src/app/rosetta/lib/account.ml
@@ -108,7 +108,7 @@ module Sql = struct
                 LIMIT 1
 |sql}
 
-    let run (module Conn : Caqti_async.CONNECTION) ~requested_block_height
+    let run (module Conn : Mina_caqti.CONNECTION) ~requested_block_height
         ~address ~token_id =
       let open Deferred.Result.Let_syntax in
       let%bind has_canonical_height =
@@ -143,7 +143,7 @@ module Sql = struct
       ~cliff_time ~cliff_amount ~vesting_period ~vesting_increment
       ~initial_minimum_balance
 
-  let find_current_balance (module Conn : Caqti_async.CONNECTION)
+  let find_current_balance (module Conn : Mina_caqti.CONNECTION)
       ~requested_block_global_slot_since_genesis ~last_relevant_command_info
       ?timing_id () =
     let open Deferred.Result.Let_syntax in
@@ -198,7 +198,7 @@ module Sql = struct
     let balance_info : Balance_info.t = { liquid_balance; total_balance } in
     Deferred.Result.return (balance_info, nonce)
 
-  let run (module Conn : Caqti_async.CONNECTION) ~block_query
+  let run (module Conn : Mina_caqti.CONNECTION) ~block_query
       ~address ~token_id =
     let open Deferred.Result.Let_syntax in
     (* First find the block referenced by the block identifier. Then
@@ -298,7 +298,7 @@ module Balance = struct
       ; db_block_identifier_and_balance_info =
           (fun ~block_query ~address ~token_id ->
             with_db (fun ~db ->
-                let (module Conn : Caqti_async.CONNECTION) = db in
+                let (module Conn : Mina_caqti.CONNECTION) = db in
                 Sql.run
                   (module Conn)
                   ~block_query ~address ~token_id
diff --git a/src/app/rosetta/lib/block.ml b/src/app/rosetta/lib/block.ml
index a83bde8cb0..4cd284ce54 100644
--- a/src/app/rosetta/lib/block.ml
+++ b/src/app/rosetta/lib/block.ml
@@ -557,10 +557,10 @@ module Sql = struct
         |}
            b_fields )
 
-    let run_by_id (module Conn : Caqti_async.CONNECTION) id =
+    let run_by_id (module Conn : Mina_caqti.CONNECTION) id =
       Conn.find_opt query_by_id id
 
-    let run_has_canonical_height (module Conn : Caqti_async.CONNECTION) ~height
+    let run_has_canonical_height (module Conn : Mina_caqti.CONNECTION) ~height
         =
       let open Deferred.Result.Let_syntax in
       let%map num_canonical_at_height =
@@ -568,7 +568,7 @@ module Sql = struct
       in
       Int64.( > ) num_canonical_at_height Int64.zero
 
-    let run (module Conn : Caqti_async.CONNECTION) = function
+    let run (module Conn : Mina_caqti.CONNECTION) = function
       | Some (`This (`Height h)) ->
           let open Deferred.Result.Let_syntax in
           let%bind has_canonical_height =
@@ -693,7 +693,7 @@ module Sql = struct
         |}
            fields )
 
-    let run (module Conn : Caqti_async.CONNECTION) id =
+    let run (module Conn : Mina_caqti.CONNECTION) id =
       Conn.collect_list query (id, Mina_base.Token_id.(to_string default))
   end
 
@@ -761,7 +761,7 @@ module Sql = struct
       |}
            fields )
 
-    let run (module Conn : Caqti_async.CONNECTION) id =
+    let run (module Conn : Mina_caqti.CONNECTION) id =
       Conn.collect_list query (id, Mina_base.Token_id.(to_string default))
   end
 
@@ -830,7 +830,7 @@ module Sql = struct
          WHERE bzc.block_id = ?
       |}
 
-    let run (module Conn : Caqti_async.CONNECTION) id =
+    let run (module Conn : Mina_caqti.CONNECTION) id =
       Conn.collect_list query id
   end
 
@@ -878,12 +878,12 @@ module Sql = struct
     |}
            fields )
 
-    let run (module Conn : Caqti_async.CONNECTION) command_id block_id =
+    let run (module Conn : Mina_caqti.CONNECTION) command_id block_id =
       Conn.collect_list query
         (command_id, Mina_base.Token_id.(to_string default), block_id)
   end
 
-  let run (module Conn : Caqti_async.CONNECTION) input =
+  let run (module Conn : Mina_caqti.CONNECTION) input =
     let module M = struct
       include Deferred.Result
 
@@ -1116,12 +1116,12 @@ module Specific = struct
     module Mock = T (Result)
 
     let real :
-        logger:Logger.t -> db:(module Caqti_async.CONNECTION) -> 'gql Real.t =
+        logger:Logger.t -> db:(module Mina_caqti.CONNECTION) -> 'gql Real.t =
      fun ~logger ~db ->
       { logger
       ; db_block =
           (fun query ->
-            let (module Conn : Caqti_async.CONNECTION) = db in
+            let (module Conn : Mina_caqti.CONNECTION) = db in
             Sql.run (module Conn) query )
       ; validate_network_choice = Network.Validate_choice.Real.validate
       }
diff --git a/src/app/rosetta/lib/construction.ml b/src/app/rosetta/lib/construction.ml
index af035097f8..318bc7ff7a 100644
--- a/src/app/rosetta/lib/construction.ml
+++ b/src/app/rosetta/lib/construction.ml
@@ -878,7 +878,7 @@ module Submit = struct
                 AND uc.amount = $4
                 AND uc.fee = $5 |sql}
 
-      let run (module Conn : Caqti_async.CONNECTION) ~nonce ~source ~receiver
+      let run (module Conn : Mina_caqti.CONNECTION) ~nonce ~source ~receiver
           ~amount ~fee =
         let open Unsigned_extended in
         Conn.find_opt query
@@ -926,7 +926,7 @@ module Submit = struct
     module Mock = T (Result)
 
     let real :
-           db:(module Caqti_async.CONNECTION)
+           db:(module Mina_caqti.CONNECTION)
         -> graphql_uri:Uri.t
         -> ( 'gql_payment
            , 'gql_delegation
diff --git a/src/app/rosetta/lib/network.ml b/src/app/rosetta/lib/network.ml
index 01a963e7af..65abac7842 100644
--- a/src/app/rosetta/lib/network.ml
+++ b/src/app/rosetta/lib/network.ml
@@ -217,9 +217,9 @@ module Status = struct
     let oldest_block_ref = ref None
 
     let real :
-        db:(module Caqti_async.CONNECTION) -> graphql_uri:Uri.t -> 'gql Real.t =
+        db:(module Mina_caqti.CONNECTION) -> graphql_uri:Uri.t -> 'gql Real.t =
      fun ~db ~graphql_uri ->
-      let (module Db : Caqti_async.CONNECTION) = db in
+      let (module Db : Mina_caqti.CONNECTION) = db in
       { gql = Get_status_t.query ~graphql_uri
       ; db_oldest_block =
           (fun () ->
diff --git a/src/app/rosetta/lib/pg_data.ml b/src/app/rosetta/lib/pg_data.ml
index 699b661aa4..1dda81f8e9 100644
--- a/src/app/rosetta/lib/pg_data.ml
+++ b/src/app/rosetta/lib/pg_data.ml
@@ -6,7 +6,7 @@ let query_connection_count =
               WHERE state = 'active'
         |sql}
 
-let run_connection_count (module Conn : Caqti_async.CONNECTION) =
+let run_connection_count (module Conn : Mina_caqti.CONNECTION) =
   Conn.find query_connection_count
 
 let query_lock_count =
@@ -15,5 +15,5 @@ let query_lock_count =
               WHERE mode = 'SIReadLock'
         |sql}
 
-let run_lock_count (module Conn : Caqti_async.CONNECTION) =
+let run_lock_count (module Conn : Mina_caqti.CONNECTION) =
   Conn.find query_lock_count
diff --git a/src/app/rosetta/lib/rosetta.ml b/src/app/rosetta/lib/rosetta.ml
index 965e68e2a7..c1b616a71e 100644
--- a/src/app/rosetta/lib/rosetta.ml
+++ b/src/app/rosetta/lib/rosetta.ml
@@ -4,7 +4,7 @@ open Rosetta_lib
 
 let router ~graphql_uri
     ~(pool :
-       ( (Caqti_async.connection, [> Caqti_error.connect ]) Caqti_async.Pool.t
+       ( (Caqti_async.connection, [> Caqti_error.connect ]) Mina_caqti.Pool.t
        , [ `App of Errors.t ] )
        Deferred.Result.t
        lazy_t ) ~logger route body =
@@ -18,7 +18,7 @@ let router ~graphql_uri
   in
   let with_db f =
     let%bind pool = Lazy.force pool in
-    Caqti_async.Pool.use (fun db -> f ~db) pool
+    Mina_caqti.Pool.use (fun db -> f ~db) pool
     |> Deferred.Result.map_error ~f:(function
          | `App e ->
              `App e
@@ -62,7 +62,7 @@ let pg_log_data ~logger ~pool : unit Deferred.t =
   match%bind Lazy.force pool with
   | Ok pool ->
       let get_logs () : (unit, _) Deferred.Result.t =
-        Caqti_async.Pool.use
+        Mina_caqti.Pool.use
           (fun db ->
             let open Deferred.Result.Let_syntax in
             let%bind num_conns = Pg_data.run_connection_count db () in
@@ -187,10 +187,7 @@ let command =
               "MINA_ROSETTA_MAX_DB_POOL_SIZE not set or invalid. Please set \
                this to a number (try 64 or 128)"
         in
-        match Caqti_async.connect_pool       ~pool_config:
-        Caqti_pool_config.(
-          merge_left (default_from_env ()) (create ~max_size:max_pool_size ()))
- archive_uri with
+        match Mina_caqti.connect_pool ~max_size:max_pool_size archive_uri with
         | Error e ->
             [%log error]
               ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/app/swap_bad_balances/sql.ml b/src/app/swap_bad_balances/sql.ml
index d8d6172857..bd85672b7e 100644
--- a/src/app/swap_bad_balances/sql.ml
+++ b/src/app/swap_bad_balances/sql.ml
@@ -15,12 +15,11 @@ module Receiver_balances = struct
             WHERE b.state_hash = $1 AND bic.sequence_no = $2
       |sql}
 
-  let run_ids_from_fee_transfer (module Conn : Caqti_async.CONNECTION)
-      state_hash seq_no =
+  let run_ids_from_fee_transfer (module Conn : Mina_caqti.CONNECTION) state_hash
+      seq_no =
     Conn.collect_list query_ids_from_fee_transfer (state_hash, seq_no)
 
-  let add_if_doesn't_exist (module Conn : Caqti_async.CONNECTION) (pk, balance)
-      =
+  let add_if_doesn't_exist (module Conn : Mina_caqti.CONNECTION) (pk, balance) =
     let open Deferred.Result.Let_syntax in
     (* if duplicates, any is acceptable *)
     match%bind
@@ -47,7 +46,7 @@ module Receiver_balances = struct
               RETURNING id" )
           (pk, balance)
 
-  let load (module Conn : Caqti_async.CONNECTION) id =
+  let load (module Conn : Mina_caqti.CONNECTION) id =
     Conn.find
       (Mina_caqti.find_req
          Caqti_type.(int)
@@ -69,7 +68,7 @@ module Receiver_balances = struct
             AND bic.receiver_balance = $3
       |sql}
 
-  let swap_in_new_balance (module Conn : Caqti_async.CONNECTION) state_hash
+  let swap_in_new_balance (module Conn : Mina_caqti.CONNECTION) state_hash
       seq_no old_balance_id new_balance_id =
     Conn.exec query_swap_in_new_balance
       (state_hash, seq_no, old_balance_id, new_balance_id)
diff --git a/src/app/swap_bad_balances/swap_bad_balances.ml b/src/app/swap_bad_balances/swap_bad_balances.ml
index a01bb86938..5ff0d88e9f 100644
--- a/src/app/swap_bad_balances/swap_bad_balances.ml
+++ b/src/app/swap_bad_balances/swap_bad_balances.ml
@@ -4,7 +4,7 @@ open Core_kernel
 open Async
 
 let query_db pool ~f ~item =
-  match%bind Caqti_async.Pool.use f pool with
+  match%bind Mina_caqti.Pool.use f pool with
   | Ok v ->
       return v
   | Error msg ->
@@ -14,7 +14,7 @@ let query_db pool ~f ~item =
 let main ~archive_uri ~state_hash ~sequence_no () =
   let archive_uri = Uri.of_string archive_uri in
   let logger = Logger.create () in
-  match Caqti_async.connect_pool archive_uri with
+  match Mina_caqti.connect_pool archive_uri with
   | Error e ->
       [%log fatal]
         ~metadata:[ ("error", `String (Caqti_error.show e)) ]
diff --git a/src/lib/genesis_ledger_helper/genesis_ledger_helper.ml b/src/lib/genesis_ledger_helper/genesis_ledger_helper.ml
index 20b64dcbf1..667689fc29 100644
--- a/src/lib/genesis_ledger_helper/genesis_ledger_helper.ml
+++ b/src/lib/genesis_ledger_helper/genesis_ledger_helper.ml
@@ -75,10 +75,10 @@ let assert_filehash_equal ~file ~hash ~logger =
   else
     let%map () = Unix.rename ~src:file ~dst:(file ^ ".incorrect-hash") in
     [%log error]
-      "Verification failure: downloaded $file and expected SHA3-256 = $hash \
-       but it had $computed_hash"
+      "Verification failure: downloaded $file and expected SHA3-256 = \
+       $expected_hash but it had $computed_hash"
       ~metadata:
-        [ ("path", `String file)
+        [ ("file", `String file)
         ; ("expected_hash", `String hash)
         ; ("computed_hash", `String computed_hash)
         ] ;
diff --git a/src/lib/mina_caqti/mina_caqti.ml b/src/lib/mina_caqti/mina_caqti.ml
index 7dee307b08..d70a04fcba 100644
--- a/src/lib/mina_caqti/mina_caqti.ml
+++ b/src/lib/mina_caqti/mina_caqti.ml
@@ -2,9 +2,68 @@
 
 open Async
 open Core_kernel
-open Caqti_async
 open Mina_base
 
+let find_req t u s = Caqti_request.Infix.(t ->! u) s
+
+let find_opt_req t u s = Caqti_request.Infix.(t ->? u) s
+
+let collect_req t u s = Caqti_request.Infix.(t ->* u) s
+
+let exec_req t s = Caqti_request.Infix.(t ->. Caqti_type.unit) s
+
+module type CONNECTION = sig
+  include Caqti_async.CONNECTION
+
+  (** Code expects any queries to differing sources to never interfere. *)
+  val source : Uri.t
+end
+
+module Wrap
+    (Conn : Caqti_async.CONNECTION) (Arg : sig
+      val source : Uri.t
+    end) : CONNECTION = struct
+  include Conn
+  include Arg
+end
+
+let wrap_conn (module Conn : Caqti_async.CONNECTION) ~source =
+  let module Conn =
+    Wrap
+      (Conn)
+      (struct
+        let source = source
+      end)
+  in
+  (module Conn : CONNECTION)
+
+module Pool = struct
+  type ('a, 'e) t = { source : Uri.t; pool : ('a, 'e) Caqti_async.Pool.t }
+
+  let wrap ~source pool = { source; pool }
+
+  let use (f : (module CONNECTION) -> 'a) pool =
+    Caqti_async.Pool.use
+      (fun (module Conn : Caqti_async.CONNECTION) ->
+        f (wrap_conn (module Conn) ~source:pool.source) )
+      pool.pool
+end
+
+let connect_pool ?max_size uri =
+  let size = max_size in
+  let%map.Result pool =
+    Caqti_async.connect_pool
+      ~pool_config:
+        Caqti_pool_config.(
+          merge_left (default_from_env ()) (create ?max_size:size ()))
+      uri
+  in
+  Pool.wrap ~source:uri pool
+
+let connect uri =
+  let%map.Deferred.Result conn = Caqti_async.connect uri in
+  wrap_conn ~source:uri conn
+
 module Type_spec = struct
   type (_, _) t =
     | [] : (unit, unit) t
@@ -230,6 +289,18 @@ let insert_into_cols ~(returning : string) ~(table_name : string)
     (String.concat ~sep:", " cols)
     values returning
 
+let insert_assuming_new ~(select : string * 'select Caqti_type.t)
+    ~(table_name : string) ?tannot ~(cols : string list * 'cols Caqti_type.t)
+    (module Conn : CONNECTION) (value : 'cols) =
+  Conn.find
+    ( find_req (snd cols) (snd select)
+    @@ insert_into_cols ~returning:(fst select) ~table_name ?tannot
+         ~cols:(fst cols) () )
+    value
+
+(* run `select_cols` and return the result, if found
+   if not found, run `insert_into_cols` and return the result
+*)
 let select_insert_into_cols ~(select : string * 'select Caqti_type.t)
     ~(table_name : string) ?tannot ~(cols : string list * 'cols Caqti_type.t)
     (module Conn : CONNECTION) (value : 'cols) =
@@ -283,7 +354,7 @@ let insert_multi_into_col ~(table_name : string)
     ()
 
 let query ~f pool =
-  match%bind Caqti_async.Pool.use f pool with
+  match%bind Pool.use f pool with
   | Ok v ->
       return v
   | Error msg ->
@@ -316,11 +387,3 @@ let get_zkapp_or_ignore (item_opt : 'arg option)
 let get_opt_item (arg_opt : 'arg option)
     ~(f : 'arg -> ('res, _) Deferred.Result.t) : 'res option Deferred.t =
   make_get_opt ~of_option:Fn.id ~f arg_opt
-
-let find_req t u s = Caqti_request.Infix.(t ->! u) s
-
-let find_opt_req t u s = Caqti_request.Infix.(t ->? u) s
-
-let collect_req t u s = Caqti_request.Infix.(t ->* u) s
-
-let exec_req t s = Caqti_request.Infix.(t ->. Caqti_type.unit) s
diff --git a/src/lib/runtime_config/runtime_config.ml b/src/lib/runtime_config/runtime_config.ml
index d032bc6785..106c2d39e9 100644
--- a/src/lib/runtime_config/runtime_config.ml
+++ b/src/lib/runtime_config/runtime_config.ml
@@ -50,9 +50,13 @@ let result_opt ~f x =
   | None ->
       Result.return None
 
+let truncate_long_string s =
+  if String.length s > 100_000 then "... too long ..." else s
+
 let dump_on_error yojson x =
   Result.map_error x ~f:(fun str ->
-      str ^ "\n\nCould not parse JSON:\n" ^ Yojson.Safe.pretty_to_string yojson )
+      str ^ "\n\nCould not parse JSON:\n" ^ truncate_long_string
+      @@ Yojson.Safe.pretty_to_string yojson )
 
 let of_yojson_generic ~fields of_yojson json =
   dump_on_error json @@ of_yojson
